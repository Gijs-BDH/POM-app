<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POM – Ruimtestaat configureren</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/styles.css"/>
  <style>
    .section-header {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: #9CA3AF;
      margin-bottom: 0.85rem;
    }
    .q-section {
      padding-bottom: 1.25rem;
      margin-bottom: 1.25rem;
      border-bottom: 1px solid #F3F4F6;
    }
    .q-section:last-child { border-bottom: none; margin-bottom: 0; }
    .form-row { margin-bottom: 0.6rem; }

    /* Compact number input */
    .num-field {
      border: 1.5px solid #E5E7EB;
      border-radius: 0.5rem;
      padding: 0.45rem 0.65rem;
      font-size: 0.875rem;
      color: #374151;
      width: 80px;
      outline: none;
      text-align: center;
      background: white;
      transition: border-color 0.15s;
    }
    .num-field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(124,58,237,0.08); }

    /* Preview cluster card */
    .cl-card {
      padding: 0.6rem 0.75rem;
      border-radius: 0.625rem;
      background: #F9FAFB;
      margin-bottom: 0.5rem;
    }
    .cl-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .cl-card-name  { font-size: 0.78rem; font-weight: 600; color: #4B5563; }
    .cl-card-total { font-size: 0.78rem; font-weight: 700; color: var(--primary); }
    .cl-rooms { margin-top: 0.4rem; padding-top: 0.4rem; border-top: 1px solid #E5E7EB; }
    .room-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 0.15rem 0;
    }
    .room-name  { font-size: 0.68rem; color: #6B7280; }
    .room-m2    { font-size: 0.68rem; font-weight: 500; color: #374151; flex-shrink: 0; margin-left: 0.5rem; }
  </style>
</head>
<body class="bg-gray-50" style="min-height:100vh; padding: 2rem 2.5rem">

  <div>
    <a href="pve-stap-4-ruimte.html" class="text-xs text-gray-400 hover:text-violet-600">← Ruimte definities</a>
    <h1 id="project-titel" class="text-xl font-semibold text-gray-700 mt-1 mb-2"></h1>
    <div id="step-indicator" class="mb-5"></div>

    <div class="flex gap-6">
      <div id="nav-panel"></div>

      <div class="flex-1 flex gap-5 min-w-0">

        <!-- ── Questions form ─────────────────────────────────────── -->
        <div class="card flex-1 min-w-0" style="padding: 1.5rem; overflow-y: auto; max-height: calc(100vh - 200px);">

          <h2 class="text-base font-semibold text-gray-800 mb-0.5">Ruimtestaat configureren</h2>
          <p class="text-xs text-gray-400 mb-5">Beantwoord de vragen om de ruimtestaat samen te stellen. De berekening wordt direct bijgewerkt.</p>

          <!-- 1. Basisgegevens -->
          <div class="q-section">
            <div class="section-header">Basisgegevens</div>
            <div class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Aantal leerlingen</label>
              <input type="number" id="q-leerlingen" class="num-field" style="width:90px" value="240" min="0" max="2000" oninput="recalculate()"/>
            </div>
            <div class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Aantal FTE personeel</label>
              <input type="number" id="q-fte" class="num-field" style="width:90px" value="12" min="0" max="200" oninput="recalculate()"/>
            </div>
            <div class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Onderwijsclusters</label>
              <select id="q-clusters" class="select-field" style="max-width:220px" onchange="onClustersChange()">
                <option value="1 cluster">1 cluster</option>
                <option value="2 clusters OB+BB" selected>2 clusters (OB + BB)</option>
                <option value="3 clusters OB+MB+BB">3 clusters (OB + MB + BB)</option>
              </select>
            </div>
          </div>

          <!-- 2. Lokaalverdeling -->
          <div class="q-section">
            <div class="section-header">Lokaalverdeling</div>
            <div class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Extra lokalen</label>
              <input type="number" id="q-extra-lokalen" class="num-field" value="0" min="0" max="20" oninput="recalculate()"/>
            </div>
            <div id="row-ob" class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Lokalen onderbouw</label>
              <input type="number" id="q-ob-lokalen" class="num-field" value="4" min="0" max="30" oninput="recalculate()"/>
            </div>
            <div id="row-mb" class="form-row flex items-center gap-4" style="display:none">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Lokalen middenbouw</label>
              <input type="number" id="q-mb-lokalen" class="num-field" value="4" min="0" max="30" oninput="recalculate()"/>
            </div>
            <div id="row-bb" class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Lokalen bovenbouw</label>
              <input type="number" id="q-bb-lokalen" class="num-field" value="4" min="0" max="30" oninput="recalculate()"/>
            </div>
          </div>

          <!-- 3. Centrale ruimten -->
          <div class="q-section">
            <div class="section-header">Centrale ruimten</div>
            <div class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Ontmoetingsruimte</label>
              <select id="q-cor" class="select-field" style="max-width:220px" onchange="recalculate()">
                <option>Hele klas</option>
                <option selected>Hele cluster</option>
                <option>Hele school</option>
              </select>
            </div>
            <div class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Leerplein oppervlak</label>
              <select id="q-leerplein" class="select-field" style="max-width:220px" onchange="recalculate()">
                <!-- filled in JS -->
              </select>
            </div>
            <div class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Speellokaal</label>
              <div class="flex gap-2">
                <button class="sel-btn active" id="btn-speellokaal-ja"  onclick="setJN('speellokaal','ja',this)">Ja</button>
                <button class="sel-btn"        id="btn-speellokaal-nee" onclick="setJN('speellokaal','nee',this)">Nee</button>
              </div>
            </div>
          </div>

          <!-- 4. Aanvullende ruimten -->
          <div class="q-section">
            <div class="section-header">Aanvullende ruimten</div>
            <div class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Bibliotheek/mediaruimte</label>
              <div class="flex gap-2">
                <button class="sel-btn"        id="btn-bibliotheek-ja"  onclick="setJN('bibliotheek','ja',this)">Ja</button>
                <button class="sel-btn active" id="btn-bibliotheek-nee" onclick="setJN('bibliotheek','nee',this)">Nee</button>
              </div>
            </div>
            <div id="row-biblio-grootte" class="form-row flex items-center gap-4" style="display:none">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Grootte bibliotheek</label>
              <select id="q-biblio-grootte" class="select-field" style="max-width:220px" onchange="recalculate()">
                <option>Kwart klas</option>
                <option>Halve klas</option>
                <option>Hele klas</option>
              </select>
            </div>
            <div class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Creatief/techniekruimte</label>
              <div class="flex gap-2">
                <button class="sel-btn"        id="btn-creatieftechniek-ja"  onclick="setJN('creatieftechniek','ja',this)">Ja</button>
                <button class="sel-btn active" id="btn-creatieftechniek-nee" onclick="setJN('creatieftechniek','nee',this)">Nee</button>
              </div>
            </div>
            <div class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Prikkelarme ruimten</label>
              <div class="flex gap-2 items-center flex-wrap">
                <input type="number" id="q-prikkelarm-aantal" class="num-field" value="1" min="0" max="5" oninput="recalculate()"/>
                <select id="q-prikkelarm-grootte" class="select-field" style="max-width:200px" onchange="recalculate()">
                  <option selected>8 m² (1-2 kinderen)</option>
                  <option>16 m² (3-4 kinderen)</option>
                  <option>32 m² (4-8 kinderen)</option>
                </select>
              </div>
            </div>
            <div class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Zorg/behandelruimte</label>
              <div class="flex gap-2">
                <button class="sel-btn"        id="btn-zorgbehandel-ja"  onclick="setJN('zorgbehandel','ja',this)">Ja</button>
                <button class="sel-btn active" id="btn-zorgbehandel-nee" onclick="setJN('zorgbehandel','nee',this)">Nee</button>
              </div>
            </div>
            <div class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Was/droogruimte</label>
              <div class="flex gap-2">
                <button class="sel-btn"        id="btn-wasdroog-ja"  onclick="setJN('wasdroog','ja',this)">Ja</button>
                <button class="sel-btn active" id="btn-wasdroog-nee" onclick="setJN('wasdroog','nee',this)">Nee</button>
              </div>
            </div>
          </div>

          <!-- 5. Personeel & ondersteuning -->
          <div class="q-section">
            <div class="section-header">Personeel &amp; ondersteuning</div>
            <div class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Kantoorruimten</label>
              <select id="q-kantoor" class="select-field" style="max-width:220px" onchange="recalculate()">
                <option selected>Basis (8m²)</option>
                <option>Groot (16m²)</option>
              </select>
            </div>
            <div class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Spreekruimten</label>
              <select id="q-spreekruimte" class="select-field" style="max-width:220px" onchange="recalculate()">
                <option selected>Basis (12m²)</option>
                <option>Groot (24m²)</option>
              </select>
            </div>
            <div class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Print/kopieerruimte</label>
              <div class="flex gap-2">
                <button class="sel-btn active" id="btn-printKopie-ja"  onclick="setJN('printKopie','ja',this)">Ja</button>
                <button class="sel-btn"        id="btn-printKopie-nee" onclick="setJN('printKopie','nee',this)">Nee</button>
              </div>
            </div>
            <div class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">EHBO/kolf/rustruimte</label>
              <div class="flex gap-2">
                <button class="sel-btn active" id="btn-ehboKolfRust-ja"  onclick="setJN('ehboKolfRust','ja',this)">Ja</button>
                <button class="sel-btn"        id="btn-ehboKolfRust-nee" onclick="setJN('ehboKolfRust','nee',this)">Nee</button>
              </div>
            </div>
          </div>

          <!-- 6. Overige -->
          <div class="q-section">
            <div class="section-header">Overige</div>
            <div class="form-row flex items-center gap-4">
              <label class="text-sm text-gray-500 w-44 text-right flex-shrink-0">Bergruimte formaat</label>
              <select id="q-bergruimte" class="select-field" style="max-width:220px" onchange="recalculate()">
                <option selected>Basis (3m²)</option>
                <option>Middel (6m²)</option>
                <option>Groot (12m²)</option>
              </select>
            </div>
          </div>

        </div><!-- /form card -->

        <!-- ── Live preview ────────────────────────────────────────── -->
        <div style="width:300px; flex-shrink:0; display:flex; flex-direction:column; gap:0.75rem; max-height:calc(100vh - 200px);">

          <!-- Budget card -->
          <div class="card" style="padding:1rem; flex-shrink:0">
            <div class="text-xs font-semibold text-gray-500 mb-2">Ruimtebudget</div>
            <div id="preview-budget"></div>
          </div>

          <!-- Clusters card -->
          <div class="card" style="padding:1rem; flex:1; overflow-y:auto; min-height:0">
            <div class="text-xs font-semibold text-gray-500 mb-2">Ruimtestaat</div>
            <div id="preview-clusters"></div>
          </div>

        </div><!-- /preview -->

      </div><!-- /flex row -->
    </div><!-- /flex gap-6 -->

    <div class="flex justify-end mt-5">
      <button onclick="volgendeStap()" class="btn-primary px-6 py-2">Volgende stap</button>
    </div>
  </div>

  <script src="js/state.js"></script>
  <script src="js/calculations.js"></script>
  <script src="js/ruimtestaat-calc.js"></script>
  <script>
    // ── Init ──────────────────────────────────────────────────────────────────
    const project = getCurrentProject();
    if (!project) { window.location.href = 'index.html'; }
    const pveV = getActivePveVariant();
    if (!pveV)    { window.location.href = 'pve-stap-1-invoer.html'; }

    document.getElementById('project-titel').textContent = project.naam;
    document.getElementById('step-indicator').innerHTML  = renderStepIndicator(2, 5, ['pve-stap-2-voorzieningen.html']);
    document.getElementById('nav-panel').innerHTML       = renderNavPanel('pve', project);

    // ── Leerplein percentage options (5 % – 100 %) ───────────────────────────
    (function () {
      const sel = document.getElementById('q-leerplein');
      for (let p = 5; p <= 100; p += 5) {
        const o = document.createElement('option');
        o.value = (p / 100).toFixed(2);
        o.textContent = p + '%';
        if (p === 30) o.selected = true;
        sel.appendChild(o);
      }
    })();

    // ── Ja/Nee state ─────────────────────────────────────────────────────────
    const JN = {
      speellokaal:      'ja',
      bibliotheek:      'nee',
      creatieftechniek: 'nee',
      zorgbehandel:     'nee',
      wasdroog:         'nee',
      printKopie:       'ja',
      ehboKolfRust:     'ja',
    };

    function setJN(key, val, btn) {
      JN[key] = val;
      btn.closest('.flex.gap-2').querySelectorAll('.sel-btn')
         .forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      // Conditional sub-row visibility
      if (key === 'bibliotheek') {
        document.getElementById('row-biblio-grootte').style.display = val === 'ja' ? 'flex' : 'none';
      }
      recalculate();
    }

    // ── Cluster row visibility ────────────────────────────────────────────────
    function onClustersChange() {
      const v = document.getElementById('q-clusters').value;
      const single = v === '1 cluster';
      const triple = v === '3 clusters OB+MB+BB';
      document.getElementById('row-ob').style.display = single ? 'none' : 'flex';
      document.getElementById('row-mb').style.display = triple ? 'flex' : 'none';
      document.getElementById('row-bb').style.display = single ? 'none' : 'flex';
      recalculate();
    }

    // ── Collect current inputs ────────────────────────────────────────────────
    function getInputs() {
      return {
        leerlingen:                parseInt(document.getElementById('q-leerlingen').value)    || 0,
        fte:                       parseInt(document.getElementById('q-fte').value)           || 0,
        clusters:                  document.getElementById('q-clusters').value,
        extraLokalen:              parseInt(document.getElementById('q-extra-lokalen').value) || 0,
        aantalLokalenOB:           parseInt(document.getElementById('q-ob-lokalen').value)    || 0,
        aantalLokalenMB:           parseInt(document.getElementById('q-mb-lokalen').value)    || 0,
        aantalLokalenBB:           parseInt(document.getElementById('q-bb-lokalen').value)    || 0,
        centraleOntmoetingsruimte: document.getElementById('q-cor').value,
        leerpleinPercentage:       document.getElementById('q-leerplein').value,
        speellokaal:               JN.speellokaal      === 'ja' ? 'Ja' : 'Nee',
        bibliotheek:               JN.bibliotheek      === 'ja' ? 'Ja' : 'Nee',
        bibliotheekGrootte:        document.getElementById('q-biblio-grootte').value,
        creatiefTechniek:          JN.creatieftechniek === 'ja' ? 'Ja' : 'Nee',
        kantoorFormaat:            document.getElementById('q-kantoor').value,
        aantalPrikkelarm:          parseInt(document.getElementById('q-prikkelarm-aantal').value)   || 0,
        prikkelarmGrootte:         document.getElementById('q-prikkelarm-grootte').value,
        zorgBehandel:              JN.zorgbehandel     === 'ja' ? 'Ja' : 'Nee',
        wasDroog:                  JN.wasdroog         === 'ja' ? 'Ja' : 'Nee',
        bergruimteFormaat:         document.getElementById('q-bergruimte').value,
        printKopie:                JN.printKopie       === 'ja' ? 'Ja' : 'Nee',
        ehboKolfRust:              JN.ehboKolfRust     === 'ja' ? 'Ja' : 'Nee',
        spreekruimteFormaat:       document.getElementById('q-spreekruimte').value,
      };
    }

    // ── Recalculate + save + refresh preview ──────────────────────────────────
    function recalculate() {
      const inp    = getInputs();
      const result = RUIMTESTAAT_CALC.compute(inp);
      renderPreview(result);
      updateActivePveVariant({
        ruimtestaat: {
          type:           'berekend',
          vragen:         inp,
          clusters:       result.clusters,
          budget:         result.budget,
          netBudget:      result.netBudget,
          totaalGebruikt: result.totaalGebruikt,
        }
      });
    }

    // ── Render preview panel ──────────────────────────────────────────────────
    function renderPreview(result) {
      // Budget bar
      const budgetEl  = document.getElementById('preview-budget');
      const usedPct   = Math.min(100, Math.round((result.totaalGebruikt / result.budget) * 100));
      const overBudget = result.totaalGebruikt > result.netBudget;
      const barCol     = overBudget ? '#EF4444' : '#7C3AED';
      budgetEl.innerHTML = `
        <div style="display:flex;justify-content:space-between;font-size:0.68rem;color:#9CA3AF;margin-bottom:0.15rem">
          <span>Totaal BVO</span><span>${result.budget.toLocaleString('nl-NL')} m²</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.68rem;color:#9CA3AF;margin-bottom:0.4rem">
          <span>Beschikbaar voor ruimten (70%)</span><span>${result.netBudget.toLocaleString('nl-NL')} m²</span>
        </div>
        <div style="background:#F3F4F6;border-radius:99px;height:7px;overflow:hidden">
          <div style="background:${barCol};width:${usedPct}%;height:100%;border-radius:99px;transition:width 0.3s"></div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:0.4rem;font-size:0.73rem;font-weight:600">
          <span style="color:${barCol}">Ingedeeld: ${result.totaalGebruikt.toLocaleString('nl-NL')} m²</span>
          <span style="color:#9CA3AF">${usedPct}%</span>
        </div>
        ${overBudget ? '<p style="font-size:0.67rem;color:#EF4444;margin-top:0.4rem">Meer m² dan beschikbaar. Verklein ruimten of pas het programma aan.</p>' : ''}
      `;

      // Cluster breakdown
      const clustersEl = document.getElementById('preview-clusters');
      clustersEl.innerHTML = result.clusters.map(cl => {
        const clTotal = cl.rooms.reduce((s, r) =>
          s + parseFloat(r.aantal) * parseFloat(r.oppervlakte), 0);
        const rows = cl.rooms.map(r => {
          const total = parseFloat(r.aantal) * parseFloat(r.oppervlakte);
          const label = parseFloat(r.aantal) > 1 ? `${r.name} ×${r.aantal}` : r.name;
          return `<div class="room-row">
            <span class="room-name">${label}</span>
            <span class="room-m2">${total % 1 === 0 ? total : total.toLocaleString('nl-NL')} m²</span>
          </div>`;
        }).join('');
        return `
          <div class="cl-card">
            <div class="cl-card-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display==='none' ? '' : 'none'">
              <span class="cl-card-name">${cl.name}</span>
              <span class="cl-card-total">${Math.round(clTotal).toLocaleString('nl-NL')} m²</span>
            </div>
            <div class="cl-rooms">${rows}</div>
          </div>`;
      }).join('');
    }

    // ── Restore saved state ───────────────────────────────────────────────────
    function restoreState() {
      const saved = pveV && pveV.ruimtestaat && pveV.ruimtestaat.type === 'berekend'
        ? pveV.ruimtestaat.vragen : null;

      if (saved) {
        const n = (id, val) => { if (val !== undefined && val !== null) document.getElementById(id).value = val; };
        n('q-leerlingen',         saved.leerlingen);
        n('q-fte',                saved.fte);
        n('q-clusters',           saved.clusters);
        n('q-extra-lokalen',      saved.extraLokalen);
        n('q-ob-lokalen',         saved.aantalLokalenOB);
        n('q-mb-lokalen',         saved.aantalLokalenMB);
        n('q-bb-lokalen',         saved.aantalLokalenBB);
        n('q-cor',                saved.centraleOntmoetingsruimte);
        n('q-leerplein',          saved.leerpleinPercentage);
        n('q-kantoor',            saved.kantoorFormaat);
        n('q-bergruimte',         saved.bergruimteFormaat);
        n('q-biblio-grootte',     saved.bibliotheekGrootte);
        n('q-prikkelarm-grootte', saved.prikkelarmGrootte);
        n('q-prikkelarm-aantal',  saved.aantalPrikkelarm);
        n('q-spreekruimte',       saved.spreekruimteFormaat);

        // Restore Ja/Nee buttons
        const jnKeys = {
          speellokaal:      'speellokaal',
          bibliotheek:      'bibliotheek',
          creatiefTechniek: 'creatieftechniek',
          zorgBehandel:     'zorgbehandel',
          wasDroog:         'wasdroog',
          printKopie:       'printKopie',
          ehboKolfRust:     'ehboKolfRust',
        };
        Object.entries(jnKeys).forEach(([savedKey, stateKey]) => {
          if (!saved[savedKey]) return;
          const isJa = saved[savedKey].toLowerCase() === 'ja';
          JN[stateKey] = isJa ? 'ja' : 'nee';
          document.getElementById(`btn-${stateKey}-ja`) ?.classList.toggle('active', isJa);
          document.getElementById(`btn-${stateKey}-nee`)?.classList.toggle('active', !isJa);
        });

        // Conditional sub-row
        if (JN.bibliotheek === 'ja') {
          document.getElementById('row-biblio-grootte').style.display = 'flex';
        }
      }

      onClustersChange(); // triggers recalculate
    }

    function volgendeStap() {
      recalculate();
      window.location.href = 'pve-stap-4c-vlekkenplan.html';
    }

    // ── Boot ──────────────────────────────────────────────────────────────────
    restoreState();
  </script>
  <script src="js/dashboard-detail.js"></script>
  <script src="js/bot.js"></script>
</body>
</html>
