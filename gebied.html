<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POM – Gebied</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="css/styles.css"/>
  <style>
    #map { height: 480px; border-radius: 0.75rem; }
    .mode-pill {
      width: 100%; padding: 0.5rem 1rem; border-radius: 99px;
      border: 1.5px solid #E5E7EB; background: white;
      color: #9CA3AF; font-size: 0.8rem; font-weight: 500;
      text-align: center; cursor: pointer; transition: all 0.15s;
    }
    .mode-pill.active { border-color: #7C3AED; color: #7C3AED; box-shadow: 0 0 0 3px rgba(124,58,237,0.1); }
    .mode-pill:hover:not(.active) { border-color: #D1D5DB; color: #6B7280; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 p-8">

  <div class="max-w-7xl mx-auto">
    <a href="project-overzicht.html" class="breadcrumb">← Project overzicht</a>
    <h1 id="project-titel" class="page-title"></h1>
    <div id="step-indicator" class="mb-6"></div>

    <div class="flex gap-5">
      <div id="nav-panel" class="nav-panel"></div>

      <!-- Map -->
      <div class="flex-1">
        <div id="map"></div>
        <p id="map-hint" class="text-xs text-gray-400 mt-2 text-center hidden">
          Klik om punten te plaatsen &nbsp;·&nbsp; dubbelklik om te beëindigen
        </p>
        <p id="map-hint-select" class="text-xs text-gray-400 mt-2 text-center">
          Klik op een perceel om het te selecteren
        </p>
      </div>

      <!-- Right panel -->
      <div class="w-56 flex-shrink-0 flex flex-col gap-3">

        <!-- Location + search -->
        <div class="card p-4 flex flex-col gap-3">
          <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-widest">Locatie</h3>
          <div class="flex flex-col gap-1">
            <label class="text-xs text-gray-500">Naam variant</label>
            <input id="locatie-naam" type="text" class="input-field" placeholder="bv. Locatie Noord"/>
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-xs text-gray-500">Zoek adres</label>
            <div class="flex gap-1">
              <input id="zoek-input" type="text" class="input-field"
                     placeholder="Adres of plaats…"
                     onkeydown="if(event.key==='Enter') zoekLocatie()"/>
              <button onclick="zoekLocatie()" class="btn-primary flex-shrink-0"
                      style="padding:0.5rem 0.75rem;">→</button>
            </div>
            <div id="zoek-feedback" class="text-xs text-gray-400 leading-tight min-h-[1rem]"></div>
          </div>
          <!-- Kadaster overlay toggle -->
          <label class="flex items-center gap-2 cursor-pointer select-none">
            <input type="checkbox" id="kadaster-toggle" checked
                   onchange="toggleKadaster(this.checked)"
                   class="w-3.5 h-3.5 accent-violet-600"/>
            <span class="text-xs text-gray-500">Kadastraal percelen overlay</span>
          </label>
        </div>

        <!-- Perceel selection -->
        <div class="card p-4 flex flex-col gap-3">
          <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-widest">Perceel</h3>
          <button class="mode-pill active" id="mode-selecteer" onclick="setMode('selecteer')">
            Selecteer kavel
          </button>
          <button class="mode-pill" id="mode-teken" onclick="setMode('teken')">
            Teken handmatig
          </button>
          <div id="opp-row" class="flex items-center justify-between text-sm text-gray-600">
            <span>Oppervlak:</span>
            <span id="opp-display" class="font-semibold text-violet-700 text-xs">— m²</span>
          </div>
          <button id="clear-btn" onclick="clearPlot()"
                  class="text-xs text-gray-400 hover:text-red-500 transition-colors text-left hidden">
            ✕ Verwijder selectie
          </button>
          <div id="select-status" class="text-xs text-gray-400 leading-tight min-h-[1rem]"></div>
        </div>

        <button onclick="naarStap2()" class="btn-primary w-full">Volgende stap →</button>

      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="js/state.js"></script>
  <script>
    const project = getCurrentProject();
    if (!project) { window.location.href = 'index.html'; }

    document.getElementById('project-titel').textContent = project.naam;
    document.getElementById('step-indicator').innerHTML  = renderStepIndicator(1, 4);
    document.getElementById('nav-panel').innerHTML       = renderNavPanel('gebied', project);

    // ── Map init ─────────────────────────────────────────────────────────────
    const MAP_VIEW_KEY = 'pom_map_view_gebied_' + project.id;
    const savedView = JSON.parse(localStorage.getItem(MAP_VIEW_KEY) || 'null');
    const map = L.map('map').setView(
      savedView ? [savedView.lat, savedView.lng] : [52.2, 5.3],
      savedView ? savedView.zoom : 8
    );
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 19
    }).addTo(map);
    map.on('moveend', () => {
      const c = map.getCenter();
      localStorage.setItem(MAP_VIEW_KEY, JSON.stringify({ lat: c.lat, lng: c.lng, zoom: map.getZoom() }));
    });

    // ── Kadaster WMS overlay ─────────────────────────────────────────────────
    const kadasterLayer = L.tileLayer.wms(
      'https://service.pdok.nl/kadaster/kadastralekaart/wms/v5_0',
      { layers: 'Perceel', format: 'image/png', transparent: true, opacity: 0.6,
        attribution: '© Kadaster' }
    ).addTo(map);

    function toggleKadaster(on) {
      if (on) map.addLayer(kadasterLayer);
      else    map.removeLayer(kadasterLayer);
    }

    // ── Existing variants as context ─────────────────────────────────────────
    (project.gebiedVarianten || []).forEach(g => {
      const geo = (g.bouwbaarGebied && g.bouwbaarGebied.geo && g.bouwbaarGebied.geo.length >= 3)
                  ? g.bouwbaarGebied.geo
                  : (g.geo && g.geo.length >= 3 ? g.geo : null);
      if (geo) {
        L.polygon(geo, { color: '#F97316', fillColor: '#F97316', fillOpacity: 0.2, weight: 1.5 }).addTo(map);
      }
    });

    // ── Plot state ───────────────────────────────────────────────────────────
    let currentMode  = 'selecteer';
    let plotPoly     = null;   // the selected/drawn polygon on the map
    let plotGeo      = null;   // [[lat,lng], …]
    let plotOpp      = 0;
    let drawPoints   = [];

    function calcAreaM2(latlngs) {
      if (!latlngs || latlngs.length < 3) return 0;
      let area = 0;
      const n = latlngs.length;
      for (let i = 0; i < n; i++) {
        const j = (i + 1) % n;
        area += latlngs[i].lat * latlngs[j].lng;
        area -= latlngs[j].lat * latlngs[i].lng;
      }
      const DEG_TO_M = 111320;
      return Math.round(Math.abs(area / 2) * DEG_TO_M * DEG_TO_M * Math.cos(52 * Math.PI / 180));
    }

    function showPlot(geo, opp) {
      if (plotPoly) map.removeLayer(plotPoly);
      plotGeo  = geo;
      plotOpp  = opp;
      plotPoly = L.polygon(geo, { color: '#7C3AED', fillColor: '#7C3AED', fillOpacity: 0.25, weight: 2 }).addTo(map);
      document.getElementById('opp-display').textContent = opp.toLocaleString('nl-NL') + ' m²';
      document.getElementById('clear-btn').classList.remove('hidden');
    }

    function clearPlot() {
      if (plotPoly) { map.removeLayer(plotPoly); plotPoly = null; }
      plotGeo = null; plotOpp = 0; drawPoints = [];
      document.getElementById('opp-display').textContent = '— m²';
      document.getElementById('clear-btn').classList.add('hidden');
      document.getElementById('select-status').textContent = '';
    }

    // ── Mode toggle ──────────────────────────────────────────────────────────
    function setMode(m) {
      currentMode = m;
      document.getElementById('mode-selecteer').classList.toggle('active', m === 'selecteer');
      document.getElementById('mode-teken').classList.toggle('active', m === 'teken');
      document.getElementById('map-hint').classList.toggle('hidden', m !== 'teken');
      document.getElementById('map-hint-select').classList.toggle('hidden', m !== 'selecteer');
      if (m === 'teken') {
        map.getContainer().style.cursor = 'crosshair';
        drawPoints = [];
        if (plotPoly) { map.removeLayer(plotPoly); plotPoly = null; }
        document.getElementById('select-status').textContent = '';
      } else {
        map.getContainer().style.cursor = '';
        drawPoints = [];
      }
    }

    // ── Map click: selecteer or teken ────────────────────────────────────────
    map.on('click', async e => {
      if (currentMode === 'selecteer') {
        await selecteerKavel(e.latlng);
      } else {
        // Manual drawing: add point
        drawPoints.push([e.latlng.lat, e.latlng.lng]);
        if (drawPoints.length >= 3) {
          if (plotPoly) map.removeLayer(plotPoly);
          plotPoly = L.polygon(drawPoints, { color: '#7C3AED', fillColor: '#7C3AED', fillOpacity: 0.25, weight: 2 }).addTo(map);
          const opp = calcAreaM2(plotPoly.getLatLngs()[0]);
          document.getElementById('opp-display').textContent = opp.toLocaleString('nl-NL') + ' m²';
          document.getElementById('clear-btn').classList.remove('hidden');
          plotOpp = opp;
        }
      }
    });

    map.on('dblclick', e => {
      if (currentMode !== 'teken' || drawPoints.length < 3) return;
      plotGeo = plotPoly.getLatLngs()[0].map(p => [p.lat, p.lng]);
      plotOpp = calcAreaM2(plotPoly.getLatLngs()[0]);
      document.getElementById('opp-display').textContent = plotOpp.toLocaleString('nl-NL') + ' m²';
      document.getElementById('map-hint').classList.add('hidden');
      map.getContainer().style.cursor = '';
      currentMode = 'teken'; // stay in teken but stop collecting points
      drawPoints  = [];
    });

    // ── Kadaster parcel lookup via PDOK WFS ───────────────────────────────────
    async function selecteerKavel(latlng) {
      const status = document.getElementById('select-status');
      status.textContent = 'Zoeken naar perceel…';
      map.getContainer().style.cursor = 'wait';

      const d    = 0.0002; // ~20 m buffer
      const bbox = `${latlng.lng - d},${latlng.lat - d},${latlng.lng + d},${latlng.lat + d},urn:ogc:def:crs:EPSG::4326`;
      const url  = `https://service.pdok.nl/kadaster/kadastralekaart/wfs/v5_0?service=WFS&version=2.0.0&request=GetFeature&typeName=kadastralekaart:Perceel&outputFormat=application/json&count=1&srsName=urn:ogc:def:crs:EPSG::4326&bbox=${bbox}`;

      try {
        const data = await fetch(url).then(r => r.json());
        map.getContainer().style.cursor = '';
        if (data.features && data.features.length > 0) {
          const feat  = data.features[0];
          const geom  = feat.geometry;
          // GeoJSON coords are [lng, lat] → Leaflet needs [lat, lng]
          const rings = geom.type === 'MultiPolygon' ? geom.coordinates[0] : geom.coordinates;
          const geo   = rings[0].map(c => [c[1], c[0]]);
          const opp   = calcAreaM2(geo.map(c => ({ lat: c[0], lng: c[1] })));
          showPlot(geo, opp);
          const props = feat.properties || {};
          const label = [props.kadastralegemeente, props.sectie, props.perceelnummer]
            .filter(Boolean).join(' ');
          status.textContent = label || 'Perceel geselecteerd';
        } else {
          status.textContent = 'Geen perceel gevonden op deze locatie.';
        }
      } catch {
        map.getContainer().style.cursor = '';
        status.textContent = 'Ophalen mislukt. Probeer opnieuw of teken handmatig.';
      }
    }

    // ── Address search via Nominatim ─────────────────────────────────────────
    async function zoekLocatie() {
      const q        = document.getElementById('zoek-input').value.trim();
      const feedback = document.getElementById('zoek-feedback');
      if (!q) return;
      feedback.textContent = 'Zoeken…';
      try {
        const results = await fetch(
          `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=1&countrycodes=nl`
        ).then(r => r.json());
        if (results.length) {
          const { lat, lon, display_name } = results[0];
          map.setView([+lat, +lon], 17);
          feedback.textContent = display_name.split(',').slice(0, 2).join(', ');
        } else {
          feedback.textContent = 'Geen resultaten gevonden.';
        }
      } catch {
        feedback.textContent = 'Zoeken mislukt, probeer opnieuw.';
      }
    }

    // ── Navigate to step 2 ───────────────────────────────────────────────────
    function naarStap2() {
      const naam    = document.getElementById('locatie-naam').value.trim() || null;
      const variant = createNewGebiedVariant(naam);
      const updates = { stedenbouwbeleid: { mode: 'simpel', goedgekeurd: false } };
      if (plotGeo && plotGeo.length >= 3) {
        // Seed bouwbaarGebied with the selected/drawn plot so stap-2 has a starting point
        updates.geo           = plotGeo;
        updates.opp           = plotOpp;
        updates.bouwbaarGebied = { geo: plotGeo, opp: plotOpp };
      }
      updateGebiedVariantById(variant.id, updates);
      window.location.href = 'gebied-stap-2.html?id=' + variant.id;
    }
  </script>
</body>
</html>
