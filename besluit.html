<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POM – Besluit</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/styles.css"/>
  <style>
    .metric-pill {
      display: inline-flex; align-items: center;
      font-size: 0.7rem; border-radius: 99px;
      padding: 0.18rem 0.5rem; border: 1px solid #E5E7EB; color: #6B7280;
    }
    .view-pill {
      padding: 0.45rem 1.4rem; border-radius: 99px;
      border: 1.5px solid #E5E7EB; font-size: 0.85rem; font-weight: 500;
      cursor: pointer; background: white; color: #9CA3AF; transition: all 0.15s;
    }
    .view-pill.active { background: #7C3AED; color: white; border-color: #7C3AED; }
    .dl-btn {
      padding: 0.45rem 1.1rem; border-radius: 99px;
      border: 1.5px solid #E5E7EB; background: white;
      font-size: 0.78rem; color: #374151; cursor: pointer;
      transition: border-color 0.15s, color 0.15s; white-space: nowrap;
    }
    .dl-btn:hover { border-color: #7C3AED; color: #7C3AED; }
    .optie-card-besluit {
      position: relative;
      border: 1.5px solid #E5E7EB; border-radius: 1rem;
      overflow: hidden; background: white; flex: 1; min-width: 0;
    }
    .eigenschap-tag {
      display: inline-block; font-size: 0.62rem; font-weight: 600;
      padding: 0.1rem 0.4rem; border-radius: 99px;
      background: #F5F3FF; color: #7C3AED; border: 1px solid #DDD6FE;
    }
    .cmp-row {
      display: grid; align-items: center;
      border-bottom: 1px solid #F3F4F6; padding: 0.4rem 1rem;
    }
    .cmp-row:last-child { border-bottom: none; }
    .cmp-row.header { background: #F9FAFB; padding: 0.55rem 1rem; }
    .cmp-row.section-hdr {
      background: #F5F3FF; padding: 0.5rem 1rem;
      cursor: pointer; transition: background 0.12s;
    }
    .cmp-row.section-hdr:hover { background: #EDE9FE; }
    .cmp-row.sub-row { background: #FAFAFA; padding: 0.3rem 1rem; }
    .chev {
      display: inline-block; font-size: 0.55rem; color: #7C3AED;
      transition: transform 0.15s; line-height: 1;
    }
    #cmp-scroll {
      overflow-x: auto;
      padding-top: 0.625rem; /* space for scrollbar above content */
      transform: scaleY(-1); /* flip container: scrollbar moves to top */
      scrollbar-width: thin;
      scrollbar-color: #DDD6FE #F3F4F6;
    }
    #cmp-scroll-inner {
      transform: scaleY(-1); /* flip content back to normal */
    }
    #cmp-scroll::-webkit-scrollbar { height: 5px; }
    #cmp-scroll::-webkit-scrollbar-track { background: #F3F4F6; border-radius: 99px; }
    #cmp-scroll::-webkit-scrollbar-thumb { background: #DDD6FE; border-radius: 99px; }
    #cmp-scroll::-webkit-scrollbar-thumb:hover { background: #7C3AED; }
    #view-kwaliteit, #view-kosten { overflow: clip; min-width: max-content; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 p-8">

  <div class="max-w-6xl mx-auto">
    <a href="project-overzicht.html" class="breadcrumb">← Project overzicht</a>
    <h1 id="project-titel" class="page-title"></h1>

    <div class="flex gap-6">
      <div id="nav-panel" class="nav-panel"></div>

      <div class="flex-1 min-w-0 flex flex-col gap-5">

        <!-- Controls row: toggle left, download right -->
        <div class="flex items-center justify-between gap-4">
          <div class="flex gap-2">
            <button class="view-pill active" id="pill-kwaliteit" onclick="setView('kwaliteit')">kwaliteit</button>
            <button class="view-pill"        id="pill-kosten"    onclick="setView('kosten')">kosten</button>
          </div>
          <div class="flex flex-col gap-2 items-end">
            <a href="besluit-rapport.html" class="dl-btn">Download besluit-document</a>
            <button class="dl-btn">Download aanvraag documenten</button>
            <a href="project-stap-3-beoordeling.html" class="dl-btn text-center">Wegingen instellen</a>
          </div>
        </div>

        <!-- Scrollable area: cards + tables share the same horizontal scroll -->
        <div id="cmp-scroll">
          <div id="cmp-scroll-inner" class="flex flex-col gap-5">

            <!-- Gebouw optie cards -->
            <div id="optie-cards"></div>

            <!-- Kwaliteit comparison table -->
            <div id="view-kwaliteit" class="card p-0">
              <div id="kwal-table"></div>
            </div>

            <!-- Kosten comparison table -->
            <div id="view-kosten" class="card p-0 hidden">
              <div id="kost-table"></div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="js/state.js"></script>
  <script src="js/calculations.js"></script>
  <script src="js/gebouw-opties.js"></script>
  <script>
    const project = getCurrentProject();
    if (!project) { window.location.href = 'index.html'; }
    document.getElementById('project-titel').textContent = project.naam;
    document.getElementById('nav-panel').innerHTML = renderNavPanel('besluit', project);

    const variants = project.gebouwVarianten || [];
    const CARD_W = 220; // fixed column width (px) per option — drives cards + table alignment

    const getOptie = id => window.getGebouwOptie(id);

    // ── Score helpers ───────────────────────────────────────────────────────────
    function scoreColor(s) {
      if (s >= 3.5) return '#10B981';
      if (s >= 2.5) return '#84CC16';
      if (s >= 1.5) return '#F97316';
      return '#EF4444';
    }
    function scoreLabel(s) {
      if (s >= 3.5) return 'Excellent';
      if (s >= 2.5) return 'Hoog';
      if (s >= 1.5) return 'Gemiddeld';
      return 'Laag';
    }
    function avg(obj, keys) {
      if (!obj) return 2;
      const vals = keys.map(k => obj[k] || 2);
      return vals.reduce((a, b) => a + b, 0) / vals.length;
    }
    function bar(score, h) {
      const c   = scoreColor(score);
      const pct = Math.round((score / 4) * 100);
      return `<div class="px-4">
        <div class="w-full rounded-full bg-gray-100" style="height:${h}px;">
          <div style="width:${pct}%;background:${c};height:${h}px;border-radius:99px;min-width:${h}px;"></div>
        </div>
      </div>`;
    }

    // ── Render optie cards ──────────────────────────────────────────────────────
    function renderCards() {
      const el = document.getElementById('optie-cards');
      if (!variants.length) {
        el.innerHTML = '<p class="text-sm text-gray-400 py-2">Nog geen gebouw varianten. Ga naar <a href="gebouw-stap-1-uitgangspunten.html" class="text-violet-600 hover:underline">Gebouw</a> om te beginnen.</p>';
        return;
      }
      const n = variants.length;
      // Fixed-width columns so layout doesn't depend on viewport — enables horizontal scroll
      el.style.cssText = `display:grid;grid-template-columns:14rem repeat(${n},${CARD_W}px);padding:0 1rem;column-gap:0;min-width:max-content;`;
      // Spacer matching the 14rem label column
      el.appendChild(document.createElement('div'));
      variants.forEach((v, i) => {
        const optie        = getOptie(v.geselecteerdeOptie);
        const linkedPve    = (project.pveVarianten    || []).find(p => p.id === v.pveId);
        const linkedGebied = (project.gebiedVarianten || []).find(g => g.id === v.gebiedId);
        const missingLinks = !linkedPve || !linkedGebied;

        const card = document.createElement('div');
        card.className = 'optie-card-besluit';
        card.style.margin = '0 0.5rem';
        if (missingLinks) card.style.cssText += 'opacity:0.45;filter:grayscale(0.4);';

        card.innerHTML = `
          <div class="p-3 border-b border-gray-100 flex items-start justify-between gap-1">
            <div class="min-w-0">
              <div class="text-xs text-gray-400">${v.naam}</div>
            </div>
          </div>
          <div class="p-2">
            <div class="rounded-lg overflow-hidden" style="height:80px;background:#F5F3FF;">
              ${optie ? `<img src="${optie.afbeelding}" class="w-full h-full object-cover"
                             onerror="this.parentElement.style.background='#F5F3FF';this.style.display='none'"/>` : ''}
            </div>
          </div>
          <div class="px-3 pb-2 flex flex-col gap-1" style="font-size:0.72rem;color:#9CA3AF;">
            <div>PVE: <span style="color:${linkedPve ? '#374151' : '#F87171'};font-weight:500">${linkedPve ? linkedPve.naam : 'niet gekoppeld'}</span></div>
            <div>Gebied: <span style="color:${linkedGebied ? '#374151' : '#F87171'};font-weight:500">${linkedGebied ? linkedGebied.naam : 'niet gekoppeld'}</span></div>
          </div>
          ${optie ? `
          <div class="px-3 pb-2 flex gap-1 flex-wrap">
            <span class="metric-pill">${POM_CALC.formatM2(optie.bvo)}</span>
            <span class="metric-pill" style="color:#7C3AED;border-color:#DDD6FE;">${POM_CALC.formatEuro(optie.bouwkosten)}</span>
          </div>` : `
          <div class="px-3 pb-2 text-xs text-gray-300">Nog geen optie geselecteerd</div>`}
          ${!missingLinks && optie ? `
          <div class="px-3 pb-3">
            <a href="gebouw-stap-2-opties.html?id=${v.id}&detail=1"
               class="btn-primary block w-full text-center"
               style="font-size:0.72rem;padding:0.35rem 0.5rem;">Bekijk details →</a>
          </div>` : ''}`;
        // Delete button (appended so it can reference the variant id via closure)
        const delBtn = document.createElement('button');
        delBtn.className = 'variant-delete-btn';
        delBtn.textContent = '×';
        delBtn.title = 'Verwijder variant';
        delBtn.addEventListener('click', () => {
          showConfirm('Deze variant wordt permanent verwijderd en kan niet worden hersteld.', () => {
            const p = getCurrentProject();
            updateCurrentProject({ gebouwVarianten: p.gebouwVarianten.filter(gv => gv.id !== v.id) });
            window.location.reload();
          });
        });
        card.querySelector('.p-3.border-b').appendChild(delBtn);
        el.appendChild(card);
      });
    }

    // ── Kwaliteit table ─────────────────────────────────────────────────────────
    // Rows that expand show per-slider sub-rows; noExpand rows have only 1 value.
    const KWAL_ROWS = [
      { id: 'locatie',                  label: 'Kenmerken locatie',
        sliders: ['verkeer','parkeren','fietsenstalling','buitenruimte'],
        sub: { verkeer:'Verkeer', parkeren:'Parkeren', fietsenstalling:'Fietsenstalling', buitenruimte:'Buitenruimte' } },
      { id: 'kenmerkenSchool',          label: 'Kenmerken school',
        sliders: ['structuur','aanvullendeFuncties','combinatieFuncties'],
        sub: { structuur:'Structuur', aanvullendeFuncties:'Aanvullende functies', combinatieFuncties:'Combinatiefuncties' } },
      { id: 'huisvestingConcept',       label: 'Huisvesting concept',
        sliders: ['algemeen','ruimtelijkeIndeling','logistiek','gemeenschappelijkeRuimtes','typologieLokalen'],
        sub: { algemeen:'Algemeen', ruimtelijkeIndeling:'Ruimtelijke indeling', logistiek:'Logistiek', gemeenschappelijkeRuimtes:'Gem. ruimtes', typologieLokalen:'Lokalen' } },
      { id: 'uitstraling',              label: 'Uitstraling exterieur',
        sliders: ['exterieur'],
        sub: { exterieur:'Exterieur' }, noExpand: true },
      { id: 'uitstraling',              label: 'Uitstraling interieur',
        sliders: ['interieur'],
        sub: { interieur:'Interieur' }, noExpand: true },
      { id: 'vandalismeBestendig',      label: 'Vandalisme bestendig',
        sliders: ['overzichtEnControle'],
        sub: { overzichtEnControle:'Overzicht en controle' }, noExpand: true },
      { id: 'gebruiksvriendelijkheid',  label: 'Gebruiksvriendelijkheid',
        sliders: ['hoogteverschillen','socialeVeiligheid'],
        sub: { hoogteverschillen:'Hoogteverschillen', socialeVeiligheid:'Sociale veiligheid' } },
    ];

    const openKwal = new Set();

    function renderKwalTable() {
      const n   = Math.max(variants.length, 1);
      const grd = `grid-template-columns: 14rem repeat(${n}, ${CARD_W}px);`;
      let html  = '';

      // Header
      html += `<div class="cmp-row header" style="${grd}">
        <div class="text-xs font-semibold text-gray-400 uppercase tracking-widest">Categorie</div>
        ${variants.length
          ? variants.map((v, i) => `<div class="text-xs font-semibold text-gray-600 text-center">Optie #${i + 1}</div>`).join('')
          : '<div class="text-xs text-gray-300 text-center">—</div>'}
      </div>`;

      KWAL_ROWS.forEach(row => {
        const rowKey    = row.id + '|' + row.label;
        const isOpen    = openKwal.has(rowKey);
        const canExpand = !row.noExpand;

        // Main row
        html += `<div class="cmp-row" style="${grd}${canExpand ? 'cursor:pointer;' : ''}"
                      ${canExpand ? `onclick="toggleKwal('${row.id}','${row.label}')"` : ''}>
          <div class="flex items-center gap-1.5">
            ${canExpand
              ? `<span class="chev" style="transform:rotate(${isOpen ? '0' : '-90'}deg)">▼</span>`
              : `<span style="color:#D1D5DB;font-size:0.7rem;line-height:1;">–</span>`}
            <span class="text-sm text-gray-700">${row.label}</span>
          </div>
          ${variants.length
            ? variants.map(v => {
                const cat   = (v.kwaliteitsBeoordeling || {})[row.id] || {};
                return bar(avg(cat, row.sliders), 8);
              }).join('')
            : '<div></div>'}
        </div>`;

        // Sub-rows when expanded
        if (canExpand && isOpen) {
          row.sliders.forEach(k => {
            html += `<div class="cmp-row sub-row" style="${grd}">
              <div class="text-xs text-gray-400 pl-5">${row.sub[k] || k}</div>
              ${variants.length
                ? variants.map(v => {
                    const cat = (v.kwaliteitsBeoordeling || {})[row.id] || {};
                    return bar(cat[k] || 2, 6);
                  }).join('')
                : '<div></div>'}
            </div>`;
          });
        }
      });

      document.getElementById('kwal-table').innerHTML = html;
    }

    function toggleKwal(id, label) {
      const key = id + '|' + label;
      if (openKwal.has(key)) openKwal.delete(key); else openKwal.add(key);
      renderKwalTable();
    }

    // ── Kosten table ────────────────────────────────────────────────────────────
    const KOST_SECTIONS = [
      {
        label: 'Bouwkosten',
        total: v => { const o = getOptie(v.geselecteerdeOptie); return o ? Math.round(o.bouwkosten * 1.15) : null; },
        rows: [
          { label: 'Type gebouw',       fn: v => { const o = getOptie(v.geselecteerdeOptie); return o ? o.naam : '—'; } },
          { label: 'BVO',               fn: v => { const o = getOptie(v.geselecteerdeOptie); return o ? POM_CALC.formatM2(o.bvo) : '—'; } },
          { label: 'Bouwkosten',        fn: v => { const o = getOptie(v.geselecteerdeOptie); return o ? POM_CALC.formatEuro(o.bouwkosten) : '—'; } },
          { label: 'Bouwkosten per m²', fn: v => { const o = getOptie(v.geselecteerdeOptie); return o ? POM_CALC.formatEuro(Math.round(o.bouwkosten / o.bvo)) : '—'; } },
          { label: 'Inrichtingskosten', fn: v => { const o = getOptie(v.geselecteerdeOptie); return o ? POM_CALC.formatEuro(Math.round(o.bouwkosten * 0.10)) : '—'; } },
          { label: 'Onvoorzien (5%)',   fn: v => { const o = getOptie(v.geselecteerdeOptie); return o ? POM_CALC.formatEuro(Math.round(o.bouwkosten * 0.05)) : '—'; } },
          { label: 'Stichtingskosten',  fn: v => { const o = getOptie(v.geselecteerdeOptie); return o ? POM_CALC.formatEuro(Math.round(o.bouwkosten * 1.15)) : '—'; }, bold: true },
        ]
      },
      {
        label: 'Onderhoudskosten',
        total: v => { const o = getOptie(v.geselecteerdeOptie); return o ? o.tco : null; },
        rows: [
          { label: 'TCO (40 jaar)',          fn: v => { const o = getOptie(v.geselecteerdeOptie); return o ? POM_CALC.formatEuro(o.tco) : '—'; } },
          { label: 'Exploitatiekosten/jr',   fn: v => { const o = getOptie(v.geselecteerdeOptie); return o ? POM_CALC.formatEuro(Math.round((o.tco - o.bouwkosten) / 40)) : '—'; } },
          { label: 'Onderhoudskosten/jr',    fn: v => { const o = getOptie(v.geselecteerdeOptie); return o ? POM_CALC.formatEuro(Math.round(o.bouwkosten * 0.01)) : '—'; } },
          { label: 'Energiekosten/jr',       fn: v => { const o = getOptie(v.geselecteerdeOptie); return o ? POM_CALC.formatEuro(Math.round(o.bvo * 25)) : '—'; } },
        ]
      }
    ];

    const openKost = new Set(['Bouwkosten', 'Onderhoudskosten']);

    function renderKostTable() {
      const n   = Math.max(variants.length, 1);
      const grd = `grid-template-columns: 14rem repeat(${n}, ${CARD_W}px);`;
      let html  = '';

      // Header
      html += `<div class="cmp-row header" style="${grd}">
        <div class="text-xs font-semibold text-gray-400 uppercase tracking-widest">Kostenpost</div>
        ${variants.length
          ? variants.map((v, i) => `<div class="text-xs font-semibold text-gray-600 text-center">Optie #${i + 1}</div>`).join('')
          : '<div class="text-xs text-gray-300 text-center">—</div>'}
      </div>`;

      KOST_SECTIONS.forEach(section => {
        const isOpen = openKost.has(section.label);

        html += `<div class="cmp-row section-hdr" style="${grd}" onclick="toggleKost('${section.label}')">
          <div class="flex items-center gap-1.5">
            <span class="chev" style="transform:rotate(${isOpen ? '0' : '-90'}deg)">▼</span>
            <span class="text-sm font-semibold text-violet-700">${section.label}</span>
          </div>
          ${variants.length
            ? variants.map(v => {
                const tot = section.total(v);
                return `<div class="text-xs font-semibold text-violet-700 text-center">${tot !== null ? POM_CALC.formatEuro(tot) : '—'}</div>`;
              }).join('')
            : '<div></div>'}
        </div>`;

        if (isOpen) {
          section.rows.forEach(row => {
            html += `<div class="cmp-row" style="${grd}">
              <div class="flex items-center gap-1.5 pl-4">
                <span style="color:#7C3AED;font-size:0.65rem;">✓</span>
                <span class="text-xs text-gray-600">${row.label}</span>
              </div>
              ${variants.length
                ? variants.map(v => `<div class="text-xs text-center ${row.bold ? 'font-semibold text-violet-700' : 'text-gray-700'}">${row.fn(v)}</div>`).join('')
                : '<div></div>'}
            </div>`;
          });
        }
      });

      document.getElementById('kost-table').innerHTML = html;
    }

    function toggleKost(label) {
      if (openKost.has(label)) openKost.delete(label); else openKost.add(label);
      renderKostTable();
    }

    // ── View toggle ─────────────────────────────────────────────────────────────
    function setView(v) {
      document.getElementById('view-kwaliteit').classList.toggle('hidden', v !== 'kwaliteit');
      document.getElementById('view-kosten').classList.toggle('hidden',    v !== 'kosten');
      document.getElementById('pill-kwaliteit').classList.toggle('active', v === 'kwaliteit');
      document.getElementById('pill-kosten').classList.toggle('active',    v === 'kosten');
    }

    // ── Init ────────────────────────────────────────────────────────────────────
    renderCards();
    renderKwalTable();
    renderKostTable();

    // ── Bot check (called after bot.js loads) ───────────────────────────────────
    function checkBesluitVarianten() {
      if (variants.length > 2) return;

      const pveVarianten    = project.pveVarianten    || [];
      const gebiedVarianten = project.gebiedVarianten || [];

      const usedPveIds    = new Set(variants.map(v => v.pveId).filter(Boolean));
      const usedGebiedIds = new Set(variants.map(v => v.gebiedId).filter(Boolean));

      const missingPve    = pveVarianten.filter(p => !usedPveIds.has(p.id));
      const missingGebied = gebiedVarianten.filter(g => !usedGebiedIds.has(g.id));

      if (missingPve.length === 0 && missingGebied.length === 0) {
        triggerBot('besluit_weinig_varianten_alle_gekoppeld');
        return;
      }

      // Build a specific message naming the unrepresented variants
      const parts = [];
      if (missingPve.length)
        parts.push('PVE-variant' + (missingPve.length > 1 ? 'en' : '') + ': ' +
          missingPve.map(p => '\u201C' + p.naam + '\u201D').join(', '));
      if (missingGebied.length)
        parts.push('gebiedsvariant' + (missingGebied.length > 1 ? 'en' : '') + ': ' +
          missingGebied.map(g => '\u201C' + g.naam + '\u201D').join(', '));

      const n   = variants.length;
      const nStr = n === 0 ? 'geen' : String(n);
      const msg = `Je hebt momenteel ${nStr} gebouwvariant${n === 1 ? '' : 'en'}. ` +
        `De volgende varianten zijn nog niet meegenomen in een gebouwoptie: ${parts.join(' en ')}. ` +
        `Overweeg een nieuwe gebouwvariant aan te maken om alle scenario\u2019s te vergelijken.`;

      triggerBotMessage(msg, [{ id: 'go_to_gebouw_nieuw', label: 'Maak nieuwe variant' }]);
    }
  </script>
  <script src="js/bot.js"></script>
  <script>checkBesluitVarianten();</script>
</body>
</html>
