<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POM – Rollen & Stakeholders</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/styles.css"/>
  <style>
    .mindmap-wrap { position:relative; width:520px; height:460px; }
    .mm-node {
      position:absolute; border-radius:50%; border:2px solid #374151;
      display:flex; flex-direction:column; align-items:center;
      justify-content:center; text-align:center; background:white;
      font-size:0.75rem; font-weight:500; color:#374151; padding:0.5rem;
    }
    .mm-center { width:80px;height:80px; border-color:#7C3AED; color:#7C3AED; font-weight:700; font-size:0.9rem; }
    .mm-sat    { width:120px;height:120px; }
    .mm-sat select { font-size:0.65rem; border:1px solid #D1D5DB; border-radius:0.25rem; padding:1px 2px; margin-top:3px; width:88%; outline:none; }
    .mm-add {
      width:80px; height:80px; border:2px dashed #7C3AED;
      color:#7C3AED; font-size:1.8rem; cursor:pointer;
      transition: background 0.15s, transform 0.15s;
    }
    .mm-add:hover { background:#F5F3FF; transform:scale(1.07); }
    svg.mm-lines { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:0; }
    .mm-node { z-index:1; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 p-8">

  <div class="max-w-5xl mx-auto flex flex-col gap-6">

    <!-- Top row: persoon toevoegen + mindmap + info -->
    <div class="flex gap-6 items-start">

      <!-- Persoon toevoegen card -->
      <div class="card w-64 flex-shrink-0">
        <h3 class="text-base font-semibold text-gray-700 mb-4">persoon toevoegen</h3>
        <div class="flex flex-col gap-3">
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-500 w-16 text-right flex-shrink-0">Naam</label>
            <input id="p-naam" type="text" class="input-field" placeholder="Naam" oninput="this.classList.remove('border-red-400')"/>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-500 w-16 text-right flex-shrink-0">email</label>
            <input id="p-email" type="email" class="input-field" placeholder="email@domein.nl" oninput="this.classList.remove('border-red-400')"/>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-500 w-16 text-right flex-shrink-0">Toegang</label>
            <select id="p-toegang" class="select-field" onchange="this.classList.remove('border-red-400')">
              <option value="">Selecteer…</option>
              <option>Beheerder</option>
              <option>Redacteur</option>
              <option>Lezer</option>
            </select>
          </div>
          <button onclick="voegPersonToe()" class="btn-primary mt-1">Toevoegen</button>
        </div>

        <!-- Lijst van toegevoegde personen -->
        <div id="personen-lijst" class="mt-4 flex flex-col gap-2"></div>
      </div>

      <!-- Mind-map -->
      <div class="flex-1 flex justify-center">
        <div class="mindmap-wrap">
          <svg class="mm-lines" id="mm-svg"></svg>

          <!-- Center -->
          <div class="mm-node mm-center" id="mm-center" style="top:50%;left:50%;transform:translate(-50%,-50%)">POM</div>

          <!-- Satellites rendered dynamically by renderNodes() -->
        </div>
      </div>
    </div>

    <!-- Info card -->
    <div class="info-card max-w-xs">
      Voor snelle trajecten is goede samenwerking nodig; schoolbestuur en gemeente kunnen
      zo effectief en efficiënt mogelijk samenwerken door de tool gezamenlijk te gebruiken.
    </div>

    <!-- Volgende stap -->
    <div class="flex justify-end">
      <button onclick="volgendeStap()" class="btn-primary px-6 py-2">maak project</button>
    </div>
  </div>

  <script src="js/state.js"></script>
  <script>
    let rollen = ['School bestuur','Stedenbouw beleid','Sport beleid','Sociaal beleid','Onderwijshuisvesting','Bouwheer'];
    const _draft = getDraft();
    let personen = _draft.stakeholders || [];
    let toewijzingen = _draft.rolToewijzingen || {};

    // Map nieuw-project-1 role names → mindmap satellite indices
    const ROL_INDEX = {
      'Schoolbestuur':        0,
      'Stedenbouw beleid':    1,
      'Sport beleid':         2,
      'Sociaal beleid':       3,
      'Onderwijshuisvesting': 4,
      'Bouwheer':             5,
    };

    // Add "Ik" as default person and assign to selected roles (runs once)
    if (!personen.some(p => p.naam === 'Ik')) {
      personen.unshift({ id: crypto.randomUUID(), naam: 'Ik', email: '', toegang: 'Beheerder' });
      setDraft({ stakeholders: personen });

      (_draft.rol || '').split(', ').filter(Boolean).forEach(rol => {
        const idx = ROL_INDEX[rol];
        if (idx !== undefined && !toewijzingen[idx]) {
          toewijzingen[idx] = 'Ik';
        }
      });
      setDraft({ rolToewijzingen: toewijzingen });
    }

    // ── Position helpers ──────────────────────────────────────────────────────
    // Distribute `total` nodes evenly on an ellipse around center
    function getNodePos(i, total, nodeSize) {
      nodeSize = nodeSize || 120;
      const W = 520, H = 460;
      const cx = W / 2, cy = H / 2 + 10; // shift center slightly down for visual balance
      const rx = 185, ry = 165;
      const angle = -Math.PI / 2 + i * (2 * Math.PI / total);
      const x = cx + rx * Math.cos(angle);
      const y = cy + ry * Math.sin(angle);
      return {
        left: ((x - nodeSize / 2) / W * 100).toFixed(1) + '%',
        top:  ((y - nodeSize / 2) / H * 100).toFixed(1) + '%',
      };
    }

    // ── Render all satellite nodes + add button ───────────────────────────────
    function renderNodes() {
      const wrap = document.querySelector('.mindmap-wrap');
      // Remove old satellites and add button
      wrap.querySelectorAll('.mm-sat, .mm-add').forEach(n => n.remove());

      const total = rollen.length + 1; // +1 for the add button

      rollen.forEach((rol, i) => {
        const pos = getNodePos(i, total);
        const div = document.createElement('div');
        div.className = 'mm-node mm-sat';
        div.id = 'mm-' + i;
        div.style.top  = pos.top;
        div.style.left = pos.left;
        div.innerHTML = `
          <span style="font-size:0.72rem;line-height:1.2;">${rol}</span>
          <select id="mm-sel-${i}" onchange="saveToewijzing(${i},this.value)"><option value="">naam</option></select>`;
        wrap.appendChild(div);
      });

      // Add "+" button circle
      const addPos = getNodePos(rollen.length, total, 80);
      const addDiv = document.createElement('div');
      addDiv.className = 'mm-node mm-add';
      addDiv.id = 'mm-add';
      addDiv.title = 'Nieuwe rol toevoegen';
      addDiv.style.top  = addPos.top;
      addDiv.style.left = addPos.left;
      addDiv.textContent = '+';
      addDiv.onclick = voegRolToe;
      wrap.appendChild(addDiv);

      updateSelects();
    }

    // ── Draw SVG lines between center and satellites ──────────────────────────
    function drawLines() {
      const svg = document.getElementById('mm-svg');
      const wrap = svg.parentElement;
      const ctr = document.getElementById('mm-center');
      const wRect = wrap.getBoundingClientRect();
      const cRect = ctr.getBoundingClientRect();
      const cx = cRect.left - wRect.left + cRect.width  / 2;
      const cy = cRect.top  - wRect.top  + cRect.height / 2;

      svg.innerHTML = '';

      // Solid lines to role nodes
      wrap.querySelectorAll('.mm-sat').forEach(sat => {
        const sRect = sat.getBoundingClientRect();
        const sx = sRect.left - wRect.left + sRect.width  / 2;
        const sy = sRect.top  - wRect.top  + sRect.height / 2;
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1', cx); line.setAttribute('y1', cy);
        line.setAttribute('x2', sx); line.setAttribute('y2', sy);
        line.setAttribute('stroke','#D1D5DB'); line.setAttribute('stroke-width','2');
        svg.appendChild(line);
      });

      // Dashed line to add button
      const addNode = document.getElementById('mm-add');
      if (addNode) {
        const sRect = addNode.getBoundingClientRect();
        const sx = sRect.left - wRect.left + sRect.width  / 2;
        const sy = sRect.top  - wRect.top  + sRect.height / 2;
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1', cx); line.setAttribute('y1', cy);
        line.setAttribute('x2', sx); line.setAttribute('y2', sy);
        line.setAttribute('stroke','#C4B5FD'); line.setAttribute('stroke-width','1.5');
        line.setAttribute('stroke-dasharray','5 3');
        svg.appendChild(line);
      }
    }

    // ── Add new role ──────────────────────────────────────────────────────────
    function voegRolToe() {
      let overlay = document.getElementById('rol-dialog-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'rol-dialog-overlay';
        overlay.className = 'pom-confirm-overlay';
        overlay.style.display = 'none';
        overlay.innerHTML = `
          <div class="pom-confirm-dialog">
            <div class="pom-confirm-title">Nieuwe rol toevoegen</div>
            <input id="rol-dialog-input" type="text" class="input-field" placeholder="Naam van de rol…"/>
            <div class="pom-confirm-actions">
              <button id="rol-dialog-cancel" class="btn-ghost">Annuleren</button>
              <button id="rol-dialog-ok" class="btn-primary">Toevoegen</button>
            </div>
          </div>`;
        document.body.appendChild(overlay);
        overlay.addEventListener('click', e => { if (e.target === overlay) overlay.style.display = 'none'; });
        document.getElementById('rol-dialog-cancel').onclick = () => { overlay.style.display = 'none'; };
        document.getElementById('rol-dialog-input').addEventListener('keydown', e => {
          if (e.key === 'Enter') document.getElementById('rol-dialog-ok').click();
          if (e.key === 'Escape') overlay.style.display = 'none';
        });
        document.getElementById('rol-dialog-ok').onclick = () => {
          const naam = document.getElementById('rol-dialog-input').value.trim();
          if (!naam) return;
          overlay.style.display = 'none';
          document.getElementById('rol-dialog-input').value = '';
          rollen.push(naam);
          renderNodes();
          setTimeout(drawLines, 50);
        };
      }
      document.getElementById('rol-dialog-input').value = '';
      overlay.style.display = 'flex';
      setTimeout(() => document.getElementById('rol-dialog-input').focus(), 50);
    }

    // ── Personen ──────────────────────────────────────────────────────────────
    function renderPersonen() {
      const lijst = document.getElementById('personen-lijst');
      lijst.innerHTML = '';
      personen.forEach((p, i) => {
        const el = document.createElement('div');
        el.className = 'flex items-center justify-between text-xs bg-gray-50 rounded-lg px-3 py-2';
        el.innerHTML = `
          <div>
            <div class="font-medium text-gray-700">${p.naam}</div>
            <div class="text-gray-400">${p.toegang}</div>
          </div>
          <button onclick="verwijderPersoon(${i})" class="text-gray-300 hover:text-red-400 text-base">&times;</button>`;
        lijst.appendChild(el);
      });
      updateSelects();
    }

    function voegPersonToe() {
      const naam    = document.getElementById('p-naam').value.trim();
      const email   = document.getElementById('p-email').value.trim();
      const toegang = document.getElementById('p-toegang').value;
      if (!naam || !email || !toegang) {
        ['p-naam','p-email','p-toegang'].forEach(id => {
          const el = document.getElementById(id);
          el.classList.toggle('border-red-400', !el.value.trim());
        });
        return;
      }
      ['p-naam','p-email','p-toegang'].forEach(id => document.getElementById(id).classList.remove('border-red-400'));
      personen.push({ id: crypto.randomUUID(), naam, email, toegang });
      setDraft({ stakeholders: personen });
      document.getElementById('p-naam').value  = '';
      document.getElementById('p-email').value = '';
      renderPersonen();
    }

    function verwijderPersoon(i) {
      personen.splice(i, 1);
      setDraft({ stakeholders: personen });
      renderPersonen();
    }

    function updateSelects() {
      rollen.forEach((_, i) => {
        const sel = document.getElementById('mm-sel-' + i);
        if (!sel) return;
        const current = toewijzingen[i] || '';
        sel.innerHTML = '<option value="">naam</option>';
        personen.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.naam; opt.textContent = p.naam;
          if (p.naam === current) opt.selected = true;
          sel.appendChild(opt);
        });
      });
    }

    function saveToewijzing(idx, val) {
      toewijzingen[idx] = val;
      setDraft({ rolToewijzingen: toewijzingen });
    }

    function volgendeStap() {
      setDraft({ stakeholders: personen, rolToewijzingen: toewijzingen });
      createProjectFromDraft();
      window.location.href = 'project-overzicht.html';
    }

    // Init
    window.addEventListener('load', () => {
      renderNodes();
      renderPersonen();
      setTimeout(drawLines, 50);
    });
    window.addEventListener('resize', drawLines);
  </script>
  <script src="js/bot.js"></script>
</body>
</html>
