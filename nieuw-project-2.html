<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POM – Rollen & Stakeholders</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/styles.css"/>
  <style>
    .mindmap-wrap { position:relative; width:520px; height:460px; }
    .mm-node {
      position:absolute; border-radius:50%; border:2px solid #374151;
      display:flex; flex-direction:column; align-items:center;
      justify-content:center; text-align:center; background:white;
      font-size:0.75rem; font-weight:500; color:#374151; padding:0.5rem;
    }
    .mm-center { width:80px;height:80px; border-color:#7C3AED; color:#7C3AED; font-weight:700; font-size:0.9rem; }
    .mm-sat    { width:120px;height:120px; }
    .mm-sat select { font-size:0.65rem; border:1px solid #D1D5DB; border-radius:0.25rem; padding:1px 2px; margin-top:3px; width:88%; outline:none; }
    svg.mm-lines { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:0; }
    .mm-node { z-index:1; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 p-8">

  <div class="max-w-5xl mx-auto flex flex-col gap-6">

    <!-- Top row: persoon toevoegen + mindmap + info -->
    <div class="flex gap-6 items-start">

      <!-- Persoon toevoegen card -->
      <div class="card w-64 flex-shrink-0">
        <h3 class="text-base font-semibold text-gray-700 mb-4">persoon toevoegen</h3>
        <div class="flex flex-col gap-3">
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-500 w-16 text-right flex-shrink-0">Naam</label>
            <input id="p-naam" type="text" class="input-field" placeholder="Naam"/>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-500 w-16 text-right flex-shrink-0">email</label>
            <input id="p-email" type="email" class="input-field" placeholder="email@domein.nl"/>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-500 w-16 text-right flex-shrink-0">Toegang</label>
            <select id="p-toegang" class="select-field">
              <option value="">Selecteer…</option>
              <option>Beheerder</option>
              <option>Redacteur</option>
              <option>Lezer</option>
            </select>
          </div>
          <button onclick="voegPersonToe()" class="btn-primary mt-1">Toevoegen</button>
        </div>

        <!-- Lijst van toegevoegde personen -->
        <div id="personen-lijst" class="mt-4 flex flex-col gap-2"></div>
      </div>

      <!-- Mind-map -->
      <div class="flex-1 flex justify-center">
        <div class="mindmap-wrap">
          <svg class="mm-lines" id="mm-svg"></svg>

          <!-- Center -->
          <div class="mm-node mm-center" id="mm-center" style="top:50%;left:50%;transform:translate(-50%,-50%)">POM</div>

          <!-- Satellites: [label, top%, left%] -->
          <div class="mm-node mm-sat" id="mm-0" style="top:2%;left:36%">
            <span>School bestuur</span>
            <select id="mm-sel-0" onchange="saveToewijzing(0,this.value)"><option value="">naam</option></select>
          </div>
          <div class="mm-node mm-sat" id="mm-1" style="top:8%;left:68%">
            <span>Stedenbouw beleid</span>
            <select id="mm-sel-1" onchange="saveToewijzing(1,this.value)"><option value="">naam</option></select>
          </div>
          <div class="mm-node mm-sat" id="mm-2" style="top:42%;left:78%">
            <span>Sport beleid</span>
            <select id="mm-sel-2" onchange="saveToewijzing(2,this.value)"><option value="">naam</option></select>
          </div>
          <div class="mm-node mm-sat" id="mm-3" style="top:68%;left:63%">
            <span>Sociaal beleid</span>
            <select id="mm-sel-3" onchange="saveToewijzing(3,this.value)"><option value="">naam</option></select>
          </div>
          <div class="mm-node mm-sat" id="mm-4" style="top:68%;left:18%">
            <span>Onderwijs-<br>huisvesting</span>
            <select id="mm-sel-4" onchange="saveToewijzing(4,this.value)"><option value="">naam</option></select>
          </div>
          <div class="mm-node mm-sat" id="mm-5" style="top:30%;left:2%">
            <span>Bouwheer</span>
            <select id="mm-sel-5" onchange="saveToewijzing(5,this.value)"><option value="">naam</option></select>
          </div>
        </div>
      </div>
    </div>

    <!-- Info card -->
    <div class="info-card max-w-xs">
      Voor snelle trajecten is goede samenwerking nodig; schoolbestuur en gemeente kunnen
      zo effectief en efficiënt mogelijk samenwerken door de tool gezamenlijk te gebruiken.
    </div>

    <!-- Volgende stap -->
    <div class="flex justify-end">
      <button onclick="volgendeStap()" class="btn-primary px-6 py-2">volgende stap</button>
    </div>
  </div>

  <script src="js/state.js"></script>
  <script>
    const ROLLEN = ['School bestuur','Stedenbouw beleid','Sport beleid','Sociaal beleid','Onderwijshuisvesting','Bouwheer'];
    const _draft = getDraft();
    let personen = _draft.stakeholders || [];
    let toewijzingen = _draft.rolToewijzingen || {};

    // Map nieuw-project-1 role names → mindmap satellite indices
    const ROL_INDEX = {
      'Schoolbestuur':        0,
      'Stedenbouw beleid':    1,
      'Sport beleid':         2,
      'Sociaal beleid':       3,
      'Onderwijshuisvesting': 4,
      'Bouwheer':             5,
    };

    // Add "Ik" as default person and assign to selected roles (runs once)
    if (!personen.some(p => p.naam === 'Ik')) {
      personen.unshift({ id: crypto.randomUUID(), naam: 'Ik', email: '', toegang: 'Beheerder' });
      setDraft({ stakeholders: personen });

      (_draft.rol || '').split(', ').filter(Boolean).forEach(rol => {
        const idx = ROL_INDEX[rol];
        if (idx !== undefined && !toewijzingen[idx]) {
          toewijzingen[idx] = 'Ik';
        }
      });
      setDraft({ rolToewijzingen: toewijzingen });
    }

    // ── Draw SVG lines between center and satellites ──────────────────────────
    function drawLines() {
      const svg = document.getElementById('mm-svg');
      const wrap = svg.parentElement;
      const ctr = document.getElementById('mm-center');
      const wRect = wrap.getBoundingClientRect();
      const cRect = ctr.getBoundingClientRect();
      const cx = cRect.left - wRect.left + cRect.width  / 2;
      const cy = cRect.top  - wRect.top  + cRect.height / 2;

      svg.innerHTML = '';
      for (let i = 0; i < 6; i++) {
        const sat  = document.getElementById('mm-' + i);
        const sRect = sat.getBoundingClientRect();
        const sx = sRect.left - wRect.left + sRect.width  / 2;
        const sy = sRect.top  - wRect.top  + sRect.height / 2;
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1', cx); line.setAttribute('y1', cy);
        line.setAttribute('x2', sx); line.setAttribute('y2', sy);
        line.setAttribute('stroke','#D1D5DB'); line.setAttribute('stroke-width','2');
        svg.appendChild(line);
      }
    }

    // ── Personen ──────────────────────────────────────────────────────────────
    function renderPersonen() {
      const lijst = document.getElementById('personen-lijst');
      lijst.innerHTML = '';
      personen.forEach((p, i) => {
        const el = document.createElement('div');
        el.className = 'flex items-center justify-between text-xs bg-gray-50 rounded-lg px-3 py-2';
        el.innerHTML = `
          <div>
            <div class="font-medium text-gray-700">${p.naam}</div>
            <div class="text-gray-400">${p.toegang}</div>
          </div>
          <button onclick="verwijderPersoon(${i})" class="text-gray-300 hover:text-red-400 text-base">&times;</button>`;
        lijst.appendChild(el);
      });
      updateSelects();
    }

    function voegPersonToe() {
      const naam    = document.getElementById('p-naam').value.trim();
      const email   = document.getElementById('p-email').value.trim();
      const toegang = document.getElementById('p-toegang').value;
      if (!naam) { alert('Vul een naam in.'); return; }
      personen.push({ id: crypto.randomUUID(), naam, email, toegang });
      setDraft({ stakeholders: personen });
      document.getElementById('p-naam').value  = '';
      document.getElementById('p-email').value = '';
      renderPersonen();
    }

    function verwijderPersoon(i) {
      personen.splice(i, 1);
      setDraft({ stakeholders: personen });
      renderPersonen();
    }

    function updateSelects() {
      for (let i = 0; i < 6; i++) {
        const sel = document.getElementById('mm-sel-' + i);
        const current = toewijzingen[i] || '';
        sel.innerHTML = '<option value="">naam</option>';
        personen.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.naam; opt.textContent = p.naam;
          if (p.naam === current) opt.selected = true;
          sel.appendChild(opt);
        });
      }
    }

    function saveToewijzing(idx, val) {
      toewijzingen[idx] = val;
      setDraft({ rolToewijzingen: toewijzingen });
    }

    function volgendeStap() {
      setDraft({ stakeholders: personen, rolToewijzingen: toewijzingen });
      window.location.href = 'nieuw-project-3.html';
    }

    // Init
    renderPersonen();
    window.addEventListener('load', () => setTimeout(drawLines, 50));
    window.addEventListener('resize', drawLines);
  </script>
</body>
</html>
