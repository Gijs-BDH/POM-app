<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POM – Gebied Context</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="css/styles.css"/>
  <style>
    #map { height: 800px; border-radius: 0.75rem; }
    .tab-pill {
      width: 100%; padding: 0.55rem 1rem; border-radius: 99px;
      border: 1.5px solid #E5E7EB; background: white;
      color: #9CA3AF; font-size: 0.8rem; font-weight: 500;
      text-align: center; cursor: pointer; transition: all 0.15s;
    }
    .tab-pill.done    { border-color: #D1FAE5; background: #ECFDF5; color: #059669; cursor: pointer; }
    .tab-pill.pending { color: #D1D5DB; border-color: #F3F4F6; cursor: default; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 p-8">

  <div class="mx-auto">
    <a href="project-overzicht.html" class="breadcrumb">← Project overzicht</a>
    <h1 id="project-titel" class="page-title"></h1>
    <div id="step-indicator" class="mb-6"></div>

    <div class="flex gap-5">
      <div id="nav-panel" class="nav-panel"></div>

      <!-- Left: kavelpaspoort display (same card as in later steps, hidden until uploaded) -->
      <div id="kavelpaspoort-panel" class="w-56 flex-shrink-0 card p-4 flex flex-col gap-3 hidden" style="min-height:480px;">
        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-widest">Kavelpaspoort</h3>
        <div class="flex-1 rounded-lg overflow-hidden">
          <img src="src/assets/img_kavelpaspoort.png" class="w-full h-full object-cover"/>
        </div>
      </div>

      <!-- Map -->
      <div class="flex-1">
        <div id="map"></div>
      </div>

      <!-- Right: tab-style upload cards -->
      <div class="w-52 flex-shrink-0 flex flex-col gap-2">
        <div id="cards-container" class="flex flex-col gap-2"></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="js/state.js"></script>
  <script>
    const params   = new URLSearchParams(window.location.search);
    const gebiedId = params.get('id');
    const project  = getCurrentProject();
    if (!project) { window.location.href = 'index.html'; }

    let variant = (project.gebiedVarianten || []).find(g => g.id === gebiedId);
    if (!variant) { window.location.href = 'project-overzicht.html'; }

    document.getElementById('project-titel').textContent = project.naam;
    document.getElementById('step-indicator').innerHTML  = renderStepIndicator(2, 5, ['gebied-stap-1b-kavels.html']);
    document.getElementById('nav-panel').innerHTML       = renderNavPanel('gebied', project);

    // ── Map ───────────────────────────────────────────────────────────────────
    const MAP_VIEW_KEY = 'pom_map_view_gebied_' + project.id;
    const savedView = JSON.parse(localStorage.getItem(MAP_VIEW_KEY) || 'null');
    const map = L.map('map').setView(
      savedView ? [savedView.lat, savedView.lng] : [52.2, 5.3],
      savedView ? savedView.zoom : 8
    );
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 19
    }).addTo(map);
    map.on('moveend', () => {
      const c = map.getCenter();
      localStorage.setItem(MAP_VIEW_KEY, JSON.stringify({ lat: c.lat, lng: c.lng, zoom: map.getZoom() }));
    });

    if (variant.geo && variant.geo.length >= 3) {
      const kavelPoly = L.polygon(variant.geo, {
        color: '#7C3AED', fillColor: '#7C3AED',
        fillOpacity: 0.06, weight: 2, dashArray: '6 4'
      }).addTo(map);
      if (!savedView) map.fitBounds(kavelPoly.getBounds(), { padding: [40, 40] });
    }

    // ── Cards definition ──────────────────────────────────────────────────────
    const CARDS = [
      {
        key:         'kavelpaspoort',
        label:       'Kavelpaspoort',
        accept:      'application/pdf,image/*',
        uploadLabel: 'Upload document',
      },
      {
        key:         'omgevingMassa',
        label:       'Omgeving massa',
        accept:      'application/pdf,.obj,.fbx,.glb,.gltf,.3ds',
        uploadLabel: 'Upload model',
      },
    ];

    let activeCard = CARDS[0];

    // ── Kavelpaspoort left-panel display ──────────────────────────────────────
    function renderKavelpaspoortPanel() {
      const panel = document.getElementById('kavelpaspoort-panel');
      if (variant.kavelpaspoort) {
        panel.classList.remove('hidden');
      } else {
        panel.classList.add('hidden');
      }
    }

    // ── Upload handling ────────────────────────────────────────────────────────
    function handleUpload(event, key) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const dataUrl = e.target.result;
        variant[key] = dataUrl;
        // Render immediately so the UI responds even if storage fails
        if (key === 'kavelpaspoort') renderKavelpaspoortPanel();
        renderCards();
        try {
          updateGebiedVariantById(gebiedId, { [key]: dataUrl });
        } catch (err) {
          console.warn('Bestand te groot om op te slaan (localStorage vol):', err);
        }
      };
      reader.readAsDataURL(file);
    }

    function clearUpload(key) {
      variant[key] = null;
      if (key === 'kavelpaspoort') renderKavelpaspoortPanel();
      renderCards();
      try {
        updateGebiedVariantById(gebiedId, { [key]: null });
      } catch (err) {
        console.warn('Opslaan mislukt:', err);
      }
    }

    // ── Render right-side tab cards ───────────────────────────────────────────
    function renderCards() {
      const container = document.getElementById('cards-container');
      container.innerHTML = '';
      const activeIdx = CARDS.findIndex(c => c.key === activeCard.key);

      CARDS.forEach((card, idx) => {
        const isDone   = !!variant[card.key];
        const isActive = idx === activeIdx;

        if (isActive) {
          const value  = variant[card.key];
          const cardEl = document.createElement('div');
          cardEl.className = 'card p-4 flex flex-col gap-3';
          cardEl.style.border = '2px solid #7C3AED';

          let previewHtml = '';
          if (value) {
            if (value.startsWith('data:application/pdf') || value.startsWith('data:application/octet')) {
              previewHtml = `<embed src="${value}" type="application/pdf" class="w-full rounded-lg" style="height:120px;"/>`;
            } else {
              previewHtml = `<img src="${value}" class="w-full rounded-lg object-contain" style="max-height:120px;"/>`;
            }
          }

          cardEl.innerHTML = `
            <h3 class="font-semibold text-sm text-gray-700">${card.label}</h3>
            ${value ? previewHtml : '<p class="text-xs text-gray-300">Nog geen bestand geüpload</p>'}
            <label class="w-full text-xs font-medium py-1.5 px-3 rounded-lg border border-violet-300 text-violet-600 hover:bg-violet-50 transition-all cursor-pointer text-center">
              ↑ ${value ? 'Vervangen' : card.uploadLabel}
              <input type="file" accept="${card.accept}" class="hidden" onchange="handleUpload(event, '${card.key}')"/>
            </label>
            ${value ? `
            <button onclick="clearUpload('${card.key}')"
              class="text-xs text-gray-400 hover:text-red-500 transition-colors text-left">
              ✕ Verwijder bestand
            </button>` : ''}
            <button onclick="volgendeCard(${idx})" class="btn-primary w-full text-sm py-2">volgende</button>`;
          container.appendChild(cardEl);
        } else {
          const pill = document.createElement('button');
          pill.className = 'tab-pill ' + (isDone ? 'done' : idx > activeIdx ? 'pending' : '');
          pill.textContent = (isDone ? '✓ ' : '') + card.label;
          if (isDone || idx < activeIdx) {
            pill.onclick = () => { activeCard = card; renderCards(); };
          }
          container.appendChild(pill);
        }
      });
    }

    function volgendeCard(currentIdx) {
      if (currentIdx + 1 < CARDS.length) {
        activeCard = CARDS[currentIdx + 1];
        renderCards();
      } else {
        window.location.href = 'gebied-stap-2-stedenbouw.html?id=' + gebiedId;
      }
    }

    // Initialise
    renderKavelpaspoortPanel();
    renderCards();
  </script>
  <script src="js/bot.js"></script>
</body>
</html>
