<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POM – Gebied Context</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link href="https://cdn.jsdelivr.net/npm/cesium@1.107/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/styles.css"/>
  <style>
    #map, #map3d { height: 800px; border-radius: 0.75rem; }
    .tab-pill {
      width: 100%; padding: 0.55rem 1rem; border-radius: 99px;
      border: 1.5px solid #E5E7EB; background: white;
      color: #9CA3AF; font-size: 0.8rem; font-weight: 500;
      text-align: center; cursor: pointer; transition: all 0.15s;
    }
    .tab-pill.done    { border-color: #D1FAE5; background: #ECFDF5; color: #059669; cursor: pointer; }
    .tab-pill.pending { color: #D1D5DB; border-color: #F3F4F6; cursor: default; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 p-8">

  <div class="mx-auto">
    <a href="project-overzicht.html" class="breadcrumb">← Project overzicht</a>
    <h1 id="project-titel" class="page-title"></h1>
    <div id="step-indicator" class="mb-6"></div>

    <div class="flex gap-5">
      <div id="nav-panel" class="nav-panel"></div>

      <!-- Left: kavelpaspoort display (same card as in later steps, hidden until uploaded) -->
      <div id="kavelpaspoort-panel" class="w-56 flex-shrink-0 card p-4 flex flex-col gap-3 hidden" style="min-height:480px;">
        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-widest">Kavelpaspoort</h3>
        <div class="flex-1 rounded-lg overflow-hidden">
          <img src="src/assets/img_kavelpaspoort.png" class="w-full h-full object-cover"/>
        </div>
      </div>

      <!-- Map -->
      <div class="flex-1">
        <div class="flex justify-end mb-2">
          <div class="inline-flex rounded-lg border border-gray-200 bg-white p-0.5">
            <button id="btn-2d" onclick="setMapMode('2d')" class="px-3 py-1 text-xs rounded-md bg-violet-600 text-white">2D</button>
            <button id="btn-3d" onclick="setMapMode('3d')" class="px-3 py-1 text-xs rounded-md text-gray-500">3D</button>
          </div>
        </div>
        <div id="map"></div>
        <div id="map3d" class="hidden"></div>
      </div>

      <!-- Right: tab-style upload cards -->
      <div class="w-52 flex-shrink-0 flex flex-col gap-2">
        <div id="cards-container" class="flex flex-col gap-2"></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>window.CESIUM_BASE_URL = 'https://cdn.jsdelivr.net/npm/cesium@1.107/Build/Cesium/';</script>
  <script src="https://cdn.jsdelivr.net/npm/cesium@1.107/Build/Cesium/Cesium.js"></script>
  <script src="js/cesium-maplibre-shim.js?v=20261030"></script>
  <script src="js/state.js"></script>
  <script>
    const params   = new URLSearchParams(window.location.search);
    const gebiedId = params.get('id');
    const project  = getCurrentProject();
    if (!project) { window.location.href = 'index.html'; }

    let variant = (project.gebiedVarianten || []).find(g => g.id === gebiedId);
    if (!variant) { window.location.href = 'project-overzicht.html'; }

    document.getElementById('project-titel').textContent = project.naam;
    document.getElementById('step-indicator').innerHTML  = renderStepIndicator(2, 5, ['gebied-stap-1b-kavels.html']);
    document.getElementById('nav-panel').innerHTML       = renderNavPanel('gebied', project);

    // ── Map ───────────────────────────────────────────────────────────────────
    const MAP_VIEW_KEY = 'pom_map_view_gebied_' + project.id;
    const savedView = JSON.parse(localStorage.getItem(MAP_VIEW_KEY) || 'null');
    const map = L.map('map').setView(
      savedView ? [savedView.lat, savedView.lng] : [52.2, 5.3],
      savedView ? savedView.zoom : 8
    );
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 19
    }).addTo(map);
    map.on('moveend', () => {
      const c = map.getCenter();
      localStorage.setItem(MAP_VIEW_KEY, JSON.stringify({ lat: c.lat, lng: c.lng, zoom: map.getZoom() }));
    });

    const map3d = new maplibregl.Map({
      container: 'map3d',
      style: {
        version: 8,
        sources: {
          osm: {
            type: 'raster',
            tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
            tileSize: 256,
            attribution: '© OpenStreetMap contributors'
          }
        },
        layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
      },
      center: [map.getCenter().lng, map.getCenter().lat],
      zoom: map.getZoom(),
      pitch: 55,
      bearing: -15
    });

    let mapMode = '2d';
    function setMapMode(mode) {
      mapMode = mode;
      const map2dEl = document.getElementById('map');
      const map3dEl = document.getElementById('map3d');
      const btn2d = document.getElementById('btn-2d');
      const btn3d = document.getElementById('btn-3d');

      if (mode === '3d') {
        const c = map.getCenter();
        map3d.setCenter([c.lng, c.lat]);
        map3d.setZoom(map.getZoom());
        map2dEl.classList.add('hidden');
        map3dEl.classList.remove('hidden');
        btn2d.className = 'px-3 py-1 text-xs rounded-md text-gray-500';
        btn3d.className = 'px-3 py-1 text-xs rounded-md bg-violet-600 text-white';
        map3d.resize();
        syncLeafletTo3D();
      } else {
        const c = map3d.getCenter();
        map.setView([c.lat, c.lng], map3d.getZoom());
        map3dEl.classList.add('hidden');
        map2dEl.classList.remove('hidden');
        btn2d.className = 'px-3 py-1 text-xs rounded-md bg-violet-600 text-white';
        btn3d.className = 'px-3 py-1 text-xs rounded-md text-gray-500';
        map.invalidateSize();
      }
    }
    window.setMapMode = setMapMode;

    let map3dReady = false;
    const sync3dSourceId = 'leaflet-polygons-src';
    function syncLeafletTo3D() {
      if (!map3dReady) return;
      const features = [];
      map.eachLayer(layer => {
        if (layer instanceof L.Polygon) {
          const gj = layer.toGeoJSON();
          if (gj && gj.geometry) {
            gj.properties = {
              fillColor: layer.options?.fillColor || layer.options?.color || '#7C3AED',
              lineColor: layer.options?.color || '#4C1D95',
              fillOpacity: layer.options?.fillOpacity ?? 0.22,
              lineWidth: layer.options?.weight ?? 1.5,
            };
            features.push(gj);
          }
        }
      });
      const fc = { type: 'FeatureCollection', features };
      const src = map3d.getSource(sync3dSourceId);
      if (src) {
        src.setData(fc);
      } else {
        map3d.addSource(sync3dSourceId, { type: 'geojson', data: fc });
        map3d.addLayer({
          id: 'leaflet-polygons-fill',
          type: 'fill',
          source: sync3dSourceId,
          paint: {
            'fill-color': ['coalesce', ['get', 'fillColor'], '#7C3AED'],
            'fill-opacity': ['coalesce', ['get', 'fillOpacity'], 0.22]
          }
        });
        map3d.addLayer({
          id: 'leaflet-polygons-line',
          type: 'line',
          source: sync3dSourceId,
          paint: {
            'line-color': ['coalesce', ['get', 'lineColor'], '#4C1D95'],
            'line-width': ['coalesce', ['get', 'lineWidth'], 1.5]
          }
        });
      }
    }
    map3d.on('load', () => { map3dReady = true; syncLeafletTo3D(); });
    map.on('layeradd', syncLeafletTo3D);
    map.on('layerremove', syncLeafletTo3D);

    if (variant.geo && variant.geo.length >= 3) {
      const kavelPoly = L.polygon(variant.geo, {
        color: '#7C3AED', fillColor: '#7C3AED',
        fillOpacity: 0.06, weight: 2, dashArray: '6 4'
      }).addTo(map);
      if (!savedView) map.fitBounds(kavelPoly.getBounds(), { padding: [40, 40] });
    }

    // ── Cards definition ──────────────────────────────────────────────────────
    const CARDS = [
      {
        key:         'kavelpaspoort',
        label:       'Kavelpaspoort',
        accept:      'application/pdf,image/*',
        uploadLabel: 'Upload document',
      },
      {
        key:         'omgevingMassa',
        label:       'Omgeving massa',
        accept:      'application/pdf,.obj,.fbx,.glb,.gltf,.3ds',
        uploadLabel: 'Upload model',
      },
    ];

    let activeCard = CARDS[0];

    // ── Kavelpaspoort left-panel display ──────────────────────────────────────
    function renderKavelpaspoortPanel() {
      const panel = document.getElementById('kavelpaspoort-panel');
      if (variant.kavelpaspoort) {
        panel.classList.remove('hidden');
      } else {
        panel.classList.add('hidden');
      }
    }

    // ── Upload handling ────────────────────────────────────────────────────────
    function handleUpload(event, key) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const dataUrl = e.target.result;
        variant[key] = dataUrl;
        // Render immediately so the UI responds even if storage fails
        if (key === 'kavelpaspoort') renderKavelpaspoortPanel();
        renderCards();
        try {
          updateGebiedVariantById(gebiedId, { [key]: dataUrl });
        } catch (err) {
          console.warn('Bestand te groot om op te slaan (localStorage vol):', err);
        }
      };
      reader.readAsDataURL(file);
    }

    function clearUpload(key) {
      variant[key] = null;
      if (key === 'kavelpaspoort') renderKavelpaspoortPanel();
      renderCards();
      try {
        updateGebiedVariantById(gebiedId, { [key]: null });
      } catch (err) {
        console.warn('Opslaan mislukt:', err);
      }
    }

    // ── Render right-side tab cards ───────────────────────────────────────────
    function renderCards() {
      const container = document.getElementById('cards-container');
      container.innerHTML = '';
      const activeIdx = CARDS.findIndex(c => c.key === activeCard.key);

      CARDS.forEach((card, idx) => {
        const isDone   = !!variant[card.key];
        const isActive = idx === activeIdx;

        if (isActive) {
          const value  = variant[card.key];
          const cardEl = document.createElement('div');
          cardEl.className = 'card p-4 flex flex-col gap-3';
          cardEl.style.border = '2px solid #7C3AED';

          let previewHtml = '';
          if (value) {
            if (value.startsWith('data:application/pdf') || value.startsWith('data:application/octet')) {
              previewHtml = `<embed src="${value}" type="application/pdf" class="w-full rounded-lg" style="height:120px;"/>`;
            } else {
              previewHtml = `<img src="${value}" class="w-full rounded-lg object-contain" style="max-height:120px;"/>`;
            }
          }

          cardEl.innerHTML = `
            <h3 class="font-semibold text-sm text-gray-700">${card.label}</h3>
            ${value ? previewHtml : '<p class="text-xs text-gray-300">Nog geen bestand geüpload</p>'}
            <label class="w-full text-xs font-medium py-1.5 px-3 rounded-lg border border-violet-300 text-violet-600 hover:bg-violet-50 transition-all cursor-pointer text-center">
              ↑ ${value ? 'Vervangen' : card.uploadLabel}
              <input type="file" accept="${card.accept}" class="hidden" onchange="handleUpload(event, '${card.key}')"/>
            </label>
            ${value ? `
            <button onclick="clearUpload('${card.key}')"
              class="text-xs text-gray-400 hover:text-red-500 transition-colors text-left">
              ✕ Verwijder bestand
            </button>` : ''}
            <button onclick="volgendeCard(${idx})" class="btn-primary w-full text-sm py-2">volgende</button>`;
          container.appendChild(cardEl);
        } else {
          const pill = document.createElement('button');
          pill.className = 'tab-pill ' + (isDone ? 'done' : idx > activeIdx ? 'pending' : '');
          pill.textContent = (isDone ? '✓ ' : '') + card.label;
          if (isDone || idx < activeIdx) {
            pill.onclick = () => { activeCard = card; renderCards(); };
          }
          container.appendChild(pill);
        }
      });
    }

    function volgendeCard(currentIdx) {
      if (currentIdx + 1 < CARDS.length) {
        activeCard = CARDS[currentIdx + 1];
        renderCards();
      } else {
        window.location.href = 'gebied-stap-2-stedenbouw.html?id=' + gebiedId;
      }
    }

    // Initialise
    renderKavelpaspoortPanel();
    renderCards();
  </script>
  <script src="js/bot.js"></script>
</body>
</html>
