<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POM – Vlekkenplan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/styles.css"/>
  <style>
    .cluster-circle {
      border: 2.5px solid #374151; border-radius:50%;
      display:flex; flex-direction:column; align-items:center;
      justify-content:center; position:relative; background:white;
    }
    .room-circle {
      border: 2px solid #374151; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      background:white; font-size:0.65rem; text-align:center;
      font-weight:500; color:#374151; cursor:pointer;
      transition:all 0.15s;
    }
    .room-circle:hover { background:#F5F3FF; border-color:#7C3AED; }
    .add-btn {
      width:36px; height:36px; border-radius:50%;
      border:2.5px solid #7C3AED; color:#7C3AED;
      display:flex; align-items:center; justify-content:center;
      font-size:1.3rem; cursor:pointer; background:white;
      transition:all 0.15s; flex-shrink:0;
    }
    .add-btn:hover { background:#7C3AED; color:white; }
    #canvas { width:100%; min-height:460px; position:relative; }
    .cluster-wrap {
      display:inline-flex; flex-direction:column; align-items:center;
      gap:0.5rem; vertical-align:top; margin:0.5rem;
    }
    .rooms-row { display:flex; flex-wrap:wrap; gap:0.5rem; justify-content:center; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 p-8">

  <div class="max-w-6xl mx-auto">
    <a href="pve-stap-4.html" class="text-xs text-gray-400 hover:text-violet-600">← Ruimte definities</a>
    <h1 id="project-titel" class="text-xl font-semibold text-gray-700 mt-1 mb-2"></h1>
    <div id="step-indicator" class="mb-4"></div>

    <div class="flex gap-6">
      <div id="nav-panel" class="nav-panel"></div>

      <div class="flex-1">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Ruimtestaat – Vlekkenplan</h2>

        <div class="flex gap-4">
          <!-- Canvas -->
          <div class="card flex-1 p-4">
            <div id="canvas" class="flex flex-wrap items-start content-start gap-3 min-h-96 bg-gray-50 rounded-xl p-4">
              <!-- clusters rendered here -->
            </div>
            <!-- Add cluster button -->
            <div class="flex items-center gap-3 mt-4 pt-4 border-t border-gray-100">
              <div class="add-btn" onclick="openNieuwCluster()">+</div>
              <span class="text-sm text-gray-400">Nieuw cluster toevoegen</span>
            </div>
          </div>

          <!-- Right panel: dashboard + info -->
          <div class="flex flex-col gap-4 w-52 flex-shrink-0">
            <div class="info-card text-xs">
              Klik <strong>+</strong> om clusters en ruimtes toe te voegen.
              Een cluster groepeert gerelateerde ruimtes (bijv. Onderbouw, Bovenbouw, Centraal).
            </div>
            <div id="dashboard-widget" class="dashboard-widget"></div>
          </div>
        </div>

        <div class="flex justify-end mt-4">
          <button onclick="volgendeStap()" class="btn-primary px-6 py-2">volgende stap</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Nieuw cluster -->
  <div id="modal-cluster" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
    <div class="card w-80">
      <h3 class="text-base font-semibold text-gray-700 mb-4">nieuw cluster</h3>
      <div class="flex gap-3">
        <input id="cluster-naam" type="text" class="input-field flex-1" placeholder="voorbeeld"/>
        <button onclick="maakCluster()" class="btn-primary px-4">Maak</button>
      </div>
      <button onclick="closeModal('modal-cluster')" class="mt-3 text-xs text-gray-400 hover:text-gray-600">Annuleer</button>
    </div>
  </div>

  <!-- Modal: Nieuwe ruimte -->
  <div id="modal-ruimte" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
    <div class="card w-80">
      <h3 class="text-base font-semibold text-gray-700 mb-4">nieuwe ruimte</h3>
      <input type="hidden" id="ruimte-cluster-idx"/>
      <div class="flex flex-col gap-3">
        <div class="flex items-center gap-3">
          <label class="text-sm text-gray-500 w-16 text-right">Naam</label>
          <input id="ruimte-naam" type="text" class="input-field flex-1" value="lokaal"/>
        </div>
        <div class="flex items-center gap-3">
          <label class="text-sm text-gray-500 w-16 text-right">Aantal</label>
          <input id="ruimte-aantal" type="number" class="input-field w-24" value="1" min="1"/>
        </div>
      </div>
      <div class="flex gap-2 mt-4">
        <button onclick="maakRuimte()" class="btn-primary flex-1">Maak</button>
        <button onclick="closeModal('modal-ruimte')" class="btn-ghost">Annuleer</button>
      </div>
    </div>
  </div>

  <script src="js/state.js"></script>
  <script src="js/calculations.js"></script>
  <script>
    const project = getCurrentProject();
    if (!project) { window.location.href = 'index.html'; }
    const pveV = getActivePveVariant();
    if (!pveV) { window.location.href = 'pve-stap-1.html'; }

    document.getElementById('project-titel').textContent = project.naam;
    document.getElementById('step-indicator').innerHTML = renderStepIndicator(2, 5, ['pve-stap-2.html']);
    document.getElementById('nav-panel').innerHTML = renderNavPanel('pve', project);
    document.getElementById('dashboard-widget').innerHTML = renderDashboard(project);

    // State: clusters = [{ naam, ruimtes:[{naam, aantal}] }]
    let clusters = [];
    const savedRS = pveV && pveV.ruimtestaat && pveV.ruimtestaat.data;
    if (savedRS && savedRS.clusters) clusters = savedRS.clusters;

    // ── Render ────────────────────────────────────────────────────────────────
    function renderCanvas() {
      const canvas = document.getElementById('canvas');
      canvas.innerHTML = '';

      clusters.forEach((cluster, ci) => {
        const wrap = document.createElement('div');
        wrap.className = 'cluster-wrap';

        // Circle (visual)
        const circle = document.createElement('div');
        circle.className = 'cluster-circle';
        circle.style.cssText = 'width:160px;height:160px;padding:12px;';

        const label = document.createElement('div');
        label.className = 'text-xs font-semibold text-gray-600 mb-2 text-center';
        label.textContent = cluster.naam;
        circle.appendChild(label);

        const roomsRow = document.createElement('div');
        roomsRow.className = 'rooms-row';

        cluster.ruimtes.forEach((r, ri) => {
          for (let n = 0; n < r.aantal; n++) {
            const rc = document.createElement('div');
            rc.className = 'room-circle';
            rc.style.cssText = 'width:44px;height:44px;';
            rc.textContent = r.naam;
            rc.title = r.naam;
            roomsRow.appendChild(rc);
          }
        });

        circle.appendChild(roomsRow);

        // Add room button inside circle
        const addRoom = document.createElement('div');
        addRoom.className = 'add-btn mt-1';
        addRoom.style.cssText = 'width:28px;height:28px;font-size:1rem;';
        addRoom.innerHTML = '+';
        addRoom.onclick = (e) => { e.stopPropagation(); openNieuweRuimte(ci); };
        circle.appendChild(addRoom);

        wrap.appendChild(circle);

        // Cluster name label
        const cname = document.createElement('div');
        cname.className = 'text-xs text-gray-500 font-medium';
        cname.textContent = cluster.naam;
        wrap.appendChild(cname);

        canvas.appendChild(wrap);
      });
    }

    // ── Modals ────────────────────────────────────────────────────────────────
    function openNieuwCluster() {
      document.getElementById('cluster-naam').value = '';
      document.getElementById('modal-cluster').classList.remove('hidden');
      setTimeout(() => document.getElementById('cluster-naam').focus(), 50);
    }

    function maakCluster() {
      const naam = document.getElementById('cluster-naam').value.trim() || 'Cluster';
      clusters.push({ naam, ruimtes: [] });
      saveAndRender();
      closeModal('modal-cluster');
    }

    function openNieuweRuimte(ci) {
      document.getElementById('ruimte-cluster-idx').value = ci;
      document.getElementById('ruimte-naam').value  = 'lokaal';
      document.getElementById('ruimte-aantal').value = 1;
      document.getElementById('modal-ruimte').classList.remove('hidden');
      setTimeout(() => document.getElementById('ruimte-naam').focus(), 50);
    }

    function maakRuimte() {
      const ci    = parseInt(document.getElementById('ruimte-cluster-idx').value);
      const naam  = document.getElementById('ruimte-naam').value.trim() || 'ruimte';
      const aantal = parseInt(document.getElementById('ruimte-aantal').value) || 1;
      clusters[ci].ruimtes.push({ naam, aantal });
      saveAndRender();
      closeModal('modal-ruimte');
    }

    function closeModal(id) {
      document.getElementById(id).classList.add('hidden');
    }

    function saveAndRender() {
      const currentPveV = getActivePveVariant();
      const rs = (currentPveV && currentPveV.ruimtestaat) || { type: 'handmatig', vragen: {} };
      updateActivePveVariant({ ruimtestaat: { ...rs, data: { clusters } } });
      renderCanvas();
    }

    function volgendeStap() {
      saveAndRender();
      window.location.href = 'pve-stap-3.html';
    }

    // Keyboard dismiss modals
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        closeModal('modal-cluster');
        closeModal('modal-ruimte');
      }
      if (e.key === 'Enter') {
        if (!document.getElementById('modal-cluster').classList.contains('hidden')) maakCluster();
        if (!document.getElementById('modal-ruimte').classList.contains('hidden'))  maakRuimte();
      }
    });

    renderCanvas();
  </script>
  <script src="js/bot.js"></script>
</body>
</html>
