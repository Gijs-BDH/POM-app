<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>POM – Gebied</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2/dist/leaflet-geoman.min.css" />
    <style>
        #map {
            height: 480px;
            border-radius: 0.75rem;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 p-8">

    <div class="max-w-7xl mx-auto">
        <a href="project-overzicht.html" class="text-xs text-gray-400 hover:text-violet-600">← Project overzicht</a>
        <h1 id="project-titel" class="page-title"></h1>
        <div id="step-indicator" class="mb-6"></div>

        <div class="flex gap-5">
            <div id="nav-panel" class="nav-panel"></div>

            <!-- Map -->
            <div class="flex-1">
                <div id="map"></div>
                <p id="map-hint" class="text-xs text-gray-400 mt-2 text-center">
                    Druk op "Selecteer kavel(s)" om kavels toe te voegen
                </p>
            </div>

            <!-- Right panel -->
            <div class="w-56 flex-shrink-0 flex flex-col gap-3">

                <!-- Locatie card -->
                <div class="card p-4 flex flex-col gap-3">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-widest">Locatie</h3>
                    <div class="text-sm font-semibold text-gray-700" id="variant-label"></div>
                    <div id="mode-badge" class="text-xs rounded-full px-2 py-0.5 self-start"></div>
                    <!-- <div class="flex flex-col gap-1">
                        <label class="text-xs text-gray-500">Zoek adres</label>
                        <div class="flex gap-1">
                            <input id="zoek-input" type="text" class="input-field"
                                   placeholder="Adres of plaats…"
                                   onkeydown="if(event.key==='Enter') zoekLocatie()" />
                            <button onclick="zoekLocatie()" class="btn-primary flex-shrink-0"
                                    style="padding:0.5rem 0.75rem;">
                                →
                            </button>
                        </div>
                        <div id="zoek-feedback" class="text-xs text-gray-400 leading-tight min-h-[1rem]"></div>
                    </div> -->
                </div>

                <!-- Selected kavels card -->
                <div class="card p-4 flex flex-col gap-3">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-widest">Geselecteerde kavels</h3>
                    <button id="selecteer-btn" onclick="toggleSelecteren()"
                            class="w-full text-xs font-medium py-1.5 px-3 rounded-lg border border-violet-300 text-violet-600 hover:bg-violet-50 transition-all">
                        Selecteer kavel(s)
                    </button>
                    <button id="merge-btn" onclick="mergeKavels()"
                            class="hidden w-full text-xs font-medium py-1.5 px-3 rounded-lg border border-emerald-300 text-emerald-600 hover:bg-emerald-50 transition-all">
                        Samenvoegen tot één
                    </button>
                    <div id="kavels-list" class="flex flex-col gap-1.5"></div>
                    <p id="kavels-empty" class="text-xs text-gray-300">Nog geen kavels geselecteerd</p>
                    <div class="flex items-center justify-between text-xs text-gray-500 pt-1 border-t border-gray-100">
                        <span>Totaal</span>
                        <span id="opp-display" class="font-semibold text-violet-700">— m²</span>
                    </div>
                </div>

                <button id="volgende-btn" onclick="naarVolgende()" class="btn-primary w-full" disabled>
                    Volgende stap →
                </button>

            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@geoman-io/leaflet-geoman-free@2/dist/leaflet-geoman.min.js"></script>
    <script src="js/state.js"></script>
    <script>
        const project = getCurrentProject();
        if (!project) { window.location.href = 'index.html'; }

        const mode = new URLSearchParams(window.location.search).get('mode') || 'bouwvlak';

        document.getElementById('project-titel').textContent = project.naam;
        document.getElementById('step-indicator').innerHTML = renderStepIndicator(1, 4);
        document.getElementById('nav-panel').innerHTML = renderNavPanel('gebied', project);

        const variantNr = (project.gebiedVarianten || []).length + 1;
        document.getElementById('variant-label').textContent = 'Gebiedsvariant ' + variantNr;

        const badge = document.getElementById('mode-badge');
        if (mode === 'onderlegger') {
            badge.textContent = 'Als onderlegger';
            badge.className = 'text-xs rounded-full px-2 py-0.5 self-start bg-orange-100 text-orange-600';
        } else {
            badge.textContent = 'Als bouwvlak';
            badge.className = 'text-xs rounded-full px-2 py-0.5 self-start bg-violet-100 text-violet-600';
        }

        // ── Map init ─────────────────────────────────────────────────────────────
        const MAP_VIEW_KEY = 'pom_map_view_gebied_' + project.id;
        const savedView = JSON.parse(localStorage.getItem(MAP_VIEW_KEY) || 'null');
        const map = L.map('map').setView(
            savedView ? [savedView.lat, savedView.lng] : [52.2, 5.3],
            savedView ? savedView.zoom : 8
        );
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            maxZoom: 19
        }).addTo(map);
        map.on('moveend', () => {
            const c = map.getCenter();
            localStorage.setItem(MAP_VIEW_KEY, JSON.stringify({ lat: c.lat, lng: c.lng, zoom: map.getZoom() }));
        });

        // ── Kadaster WMS overlay ─────────────────────────────────────────────────
        const kadasterLayer = L.tileLayer.wms(
            'https://service.pdok.nl/kadaster/kadastralekaart/wms/v5_0',
            {
                layers: 'Perceel', format: 'image/png', transparent: true, opacity: 0.6,
                attribution: '© Kadaster'
            }
        ).addTo(map);

        map.addLayer(kadasterLayer);


        // ── Existing variants as context ─────────────────────────────────────────
        (project.gebiedVarianten || []).forEach(g => {
            const geo = (g.bouwbaarGebied && g.bouwbaarGebied.geo && g.bouwbaarGebied.geo.length >= 3)
                ? g.bouwbaarGebied.geo
                : (g.geo && g.geo.length >= 3 ? g.geo : null);
            if (geo) {
                L.polygon(geo, { color: '#F97316', fillColor: '#F97316', fillOpacity: 0.2, weight: 1.5 }).addTo(map);
            }
        });

        // ── Selected kavels state ─────────────────────────────────────────────────
        let selectedKavels = []; // { id, kadastraleAanduiding, geo, opp, poly }
        let nextKavelId = 1;
        let selecterenActief = false;
        let isLoading = false;
        let editingKavelId = null;

        function toggleSelecteren() {
            if (editingKavelId !== null) stopEditKavel(editingKavelId);
            selecterenActief = !selecterenActief;
            const btn = document.getElementById('selecteer-btn');
            if (selecterenActief) {
                btn.textContent = '✕ Stoppen met selecteren';
                btn.className = 'w-full text-xs font-medium py-1.5 px-3 rounded-lg border border-red-300 text-red-500 hover:bg-red-50 transition-all';
                map.getContainer().style.cursor = 'crosshair';
                document.getElementById('map-hint').textContent = 'Klik op de kaart om kavels toe te voegen';
            } else {
                btn.textContent = 'Selecteer kavel(s)';
                btn.className = 'w-full text-xs font-medium py-1.5 px-3 rounded-lg border border-violet-300 text-violet-600 hover:bg-violet-50 transition-all';
                map.getContainer().style.cursor = '';
                document.getElementById('map-hint').textContent = 'Druk op "Selecteer kavel(s)" om kavels toe te voegen';
            }
        }

        function calcAreaM2(latlngs) {
            if (!latlngs || latlngs.length < 3) return 0;
            let area = 0;
            const n = latlngs.length;
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                area += latlngs[i].lat * latlngs[j].lng;
                area -= latlngs[j].lat * latlngs[i].lng;
            }
            const DEG_TO_M = 111320;
            return Math.round(Math.abs(area / 2) * DEG_TO_M * DEG_TO_M * Math.cos(52 * Math.PI / 180));
        }

        function pointInGeoJsonPolygon(lat, lng, geoJsonCoords) {
            const ring = geoJsonCoords[0];
            let inside = false;
            for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
                const xi = ring[i][0], yi = ring[i][1];
                const xj = ring[j][0], yj = ring[j][1];
                if (((yi > lat) !== (yj > lat)) && (lng < (xj - xi) * (lat - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }
            return inside;
        }

        async function addKavel(latlng) {
            if (isLoading) return;
            isLoading = true;
            map.getContainer().style.cursor = 'wait';
            const hint = document.getElementById('map-hint');
            hint.textContent = 'Kavel ophalen…';

            const { lat, lng } = latlng;
            const margin = 0.001;
            // WFS 2.0.0 + EPSG:4326 bbox axis order is lat,lng (not lng,lat)
            const url = `https://service.pdok.nl/kadaster/kadastralekaart/wfs/v5_0?service=WFS&version=2.0.0&request=GetFeature&typeName=kadastralekaart:Perceel&outputFormat=application/json&srsName=EPSG:4326&bbox=${lat - margin},${lng - margin},${lat + margin},${lng + margin},EPSG:4326&count=20`;

            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('WFS verzoek mislukt');
                const data = await resp.json();
                const features = data.features || [];

                let found = null;
                for (const feat of features) {
                    const geom = feat.geometry;
                    if (!geom) continue;
                    if (geom.type === 'Polygon') {
                        if (pointInGeoJsonPolygon(lat, lng, geom.coordinates)) { found = feat; break; }
                    } else if (geom.type === 'MultiPolygon') {
                        for (const poly of geom.coordinates) {
                            if (pointInGeoJsonPolygon(lat, lng, poly)) { found = feat; break; }
                        }
                        if (found) break;
                    }
                }

                if (!found) {
                    hint.textContent = 'Geen kavel gevonden op deze locatie';
                    return;
                }

                const featureId = found.id || found.properties.identificatie || '';
                if (selectedKavels.some(k => k.featureId === featureId)) {
                    hint.textContent = 'Deze kavel is al geselecteerd';
                    return;
                }

                const geom = found.geometry;
                let leafletRings;
                if (geom.type === 'Polygon') {
                    leafletRings = geom.coordinates.map(ring => ring.map(c => [c[1], c[0]]));
                } else {
                    leafletRings = geom.coordinates[0].map(ring => ring.map(c => [c[1], c[0]]));
                }
                const geo = leafletRings[0];

                const props = found.properties || {};
                const kadastraleAanduiding = props.kadastraleAanduiding
                    || (props.kadastraleGemeenteCode && props.sectie && props.perceelnummer
                        ? `${props.kadastraleGemeenteCode} ${props.sectie} ${props.perceelnummer}`
                        : null);
                const opp = props.oppervlakte
                    ? Math.round(props.oppervlakte)
                    : calcAreaM2(geo.map(c => ({ lat: c[0], lng: c[1] })));

                const poly = L.polygon(leafletRings, { color: '#7C3AED', fillColor: '#7C3AED', fillOpacity: 0.25, weight: 2 }).addTo(map);
                const id = nextKavelId++;
                selectedKavels.push({ id, featureId, kadastraleAanduiding, geo, opp, poly });
                renderKavelsList();

            } catch (err) {
                console.error(err);
                hint.textContent = 'Fout bij ophalen kavel, probeer opnieuw';
            } finally {
                isLoading = false;
                map.getContainer().style.cursor = selecterenActief ? 'crosshair' : '';
                if (selecterenActief && document.getElementById('map-hint').textContent === 'Kavel ophalen…') {
                    hint.textContent = 'Klik op de kaart om kavels toe te voegen';
                }
            }
        }

        function removeKavel(id) {
            if (editingKavelId === id) {
                const kavel = selectedKavels.find(k => k.id === id);
                if (kavel) kavel.poly.pm.disable();
                editingKavelId = null;
            }
            const idx = selectedKavels.findIndex(k => k.id === id);
            if (idx === -1) return;
            map.removeLayer(selectedKavels[idx].poly);
            selectedKavels.splice(idx, 1);
            renderKavelsList();
        }

        function startEditKavel(id) {
            if (editingKavelId !== null) stopEditKavel(editingKavelId);
            const kavel = selectedKavels.find(k => k.id === id);
            if (!kavel || !(kavel.poly instanceof L.Polygon)) return;
            editingKavelId = id;
            kavel.poly.pm.enable({ allowSelfIntersection: false });
            document.getElementById('map-hint').textContent = 'Sleep hoekpunten om het polygon aan te passen. Klik ✓ om op te slaan.';
            renderKavelsList();
        }

        function stopEditKavel(id) {
            const kavel = selectedKavels.find(k => k.id === id);
            if (!kavel) { editingKavelId = null; return; }
            kavel.poly.pm.disable();
            const latlngs = kavel.poly.getLatLngs()[0];
            kavel.geo = latlngs.map(ll => [ll.lat, ll.lng]);
            kavel.opp = calcAreaM2(latlngs);
            editingKavelId = null;
            document.getElementById('map-hint').textContent = 'Zoek een locatie of druk op "Selecteer kavel(s)" om kavels toe te voegen';
            renderKavelsList();
        }

        function mergeKavels() {
            if (selectedKavels.length < 2) return;
            if (editingKavelId !== null) stopEditKavel(editingKavelId);

            // Build Turf polygon features (convert Leaflet [lat,lng] → GeoJSON [lng,lat])
            const turfFeatures = selectedKavels.map(k => {
                const ring = k.geo.map(c => [c[1], c[0]]);
                ring.push(ring[0]); // close ring
                return turf.polygon([ring]);
            });

            const unionResult = turf.union(turf.featureCollection(turfFeatures));
            if (!unionResult) return;

            selectedKavels.forEach(k => map.removeLayer(k.poly));

            const polyStyle = { color: '#7C3AED', fillColor: '#7C3AED', fillOpacity: 0.25, weight: 2 };
            let mergedPoly, mergedGeo;

            if (unionResult.geometry.type === 'Polygon') {
                const leafletRings = unionResult.geometry.coordinates.map(ring => ring.map(c => [c[1], c[0]]));
                mergedPoly = L.polygon(leafletRings, polyStyle).addTo(map);
                mergedGeo = leafletRings[0];
            } else {
                // MultiPolygon: parcels don't touch — group them
                const group = L.featureGroup().addTo(map);
                unionResult.geometry.coordinates.forEach(poly => {
                    L.polygon(poly.map(ring => ring.map(c => [c[1], c[0]])), polyStyle).addTo(group);
                });
                mergedPoly = group;
                mergedGeo = unionResult.geometry.coordinates[0][0].map(c => [c[1], c[0]]);
            }

            const totalOpp = selectedKavels.reduce((s, k) => s + k.opp, 0);
            const id = nextKavelId++;
            selectedKavels = [{ id, featureId: 'merged-' + id, kadastraleAanduiding: 'Samengevoegd gebied', geo: mergedGeo, opp: totalOpp, poly: mergedPoly }];
            renderKavelsList();
        }

        function renderKavelsList() {
            const list = document.getElementById('kavels-list');
            const empty = document.getElementById('kavels-empty');
            const mergeBtn = document.getElementById('merge-btn');
            list.innerHTML = '';

            if (selectedKavels.length === 0) {
                empty.classList.remove('hidden');
                mergeBtn.classList.add('hidden');
                document.getElementById('opp-display').textContent = '— m²';
                document.getElementById('volgende-btn').disabled = true;
                return;
            }

            empty.classList.add('hidden');
            mergeBtn.classList.toggle('hidden', selectedKavels.length < 2 || editingKavelId !== null);

            selectedKavels.forEach((k, i) => {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-1 text-xs';
                const label = k.kadastraleAanduiding || `Kavel ${i + 1}`;
                const isEditing = editingKavelId === k.id;
                const canEdit = k.poly instanceof L.Polygon;
                row.innerHTML = `
              <span class="text-gray-600 truncate flex-1" title="${label}">${label}</span>
              <span class="text-gray-400 flex-shrink-0">${k.opp.toLocaleString('nl-NL')} m²</span>
              ${canEdit ? `<button onclick="${isEditing ? 'stopEditKavel' : 'startEditKavel'}(${k.id})"
                class="flex-shrink-0 leading-none transition-colors ${isEditing ? 'text-violet-500 hover:text-violet-700' : 'text-gray-300 hover:text-violet-400'}"
                title="${isEditing ? 'Opslaan' : 'Bewerken'}">
                ${isEditing ? '✓' : '✎'}</button>` : ''}
              <button onclick="removeKavel(${k.id})" class="text-gray-300 hover:text-red-400 transition-colors leading-none flex-shrink-0" title="Verwijderen">×</button>`;
                list.appendChild(row);
            });

            const totalOpp = selectedKavels.reduce((s, k) => s + k.opp, 0);
            document.getElementById('opp-display').textContent = totalOpp.toLocaleString('nl-NL') + ' m²';
            document.getElementById('volgende-btn').disabled = false;
        }

        // ── Address search via Nominatim ─────────────────────────────────────────
        async function zoekLocatie() {
            const q        = document.getElementById('zoek-input').value.trim();
            const feedback = document.getElementById('zoek-feedback');
            if (!q) return;
            feedback.textContent = 'Zoeken…';
            try {
                const results = await fetch(
                    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=1&countrycodes=nl`
                ).then(r => r.json());
                if (results.length) {
                    const { lat, lon, display_name } = results[0];
                    map.setView([+lat, +lon], 17);
                    feedback.textContent = display_name.split(',').slice(0, 2).join(', ');
                } else {
                    feedback.textContent = 'Geen resultaten gevonden.';
                }
            } catch {
                feedback.textContent = 'Zoeken mislukt, probeer opnieuw.';
            }
        }

        // ── Map click ────────────────────────────────────────────────────────────
        map.on('click', e => { if (selecterenActief && !isLoading && editingKavelId === null) addKavel(e.latlng); });

        // ── Navigate ─────────────────────────────────────────────────────────────
        function naarVolgende() {
            const totalOpp = selectedKavels.reduce((s, k) => s + k.opp, 0);
            const mainGeo = selectedKavels[0].geo;

            if (mode === 'onderlegger') {
                localStorage.setItem('pom_gebied_pending', JSON.stringify({
                    kavels: selectedKavels.map(k => ({ geo: k.geo, opp: k.opp })),
                    variantNr
                }));
                window.location.href = 'gebied-stap-1c-tekenen.html';
                return;
            }

            // bouwvlak: create variant directly
            const naam = 'Gebiedsvariant ' + variantNr;
            const variant = createNewGebiedVariant(naam);
            updateGebiedVariantById(variant.id, {
                stedenbouwbeleid: { mode: 'simpel', goedgekeurd: false },
                geo: mainGeo,
                opp: totalOpp,
                bouwbaarGebied: { geo: mainGeo, opp: totalOpp }
            });
            window.location.href = 'gebied-stap-2-stedenbouw.html?id=' + variant.id;
        }

        renderKavelsList();
    </script>
    <script src="js/bot.js"></script>
</body>
</html>
