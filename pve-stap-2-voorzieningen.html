<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POM – Voorzieningen</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/styles.css"/>
</head>
<body class="min-h-screen bg-gray-50 p-8">

  <div class="mx-auto">
    <a href="project-overzicht.html" class="text-xs text-gray-400 hover:text-violet-600">← Project overzicht</a>
    <h1 id="project-titel" class="text-xl font-semibold text-gray-700 mt-1 mb-2"></h1>

    <!-- Step indicator -->
    <div id="step-indicator" class="mb-6"></div>

    <div class="flex gap-6">
      <!-- Nav panel -->
      <div id="nav-panel" class="nav-panel"></div>

      <!-- Content -->
      <div class="flex-1">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Selecteer gewenste voorzieningen</h2>

        <!-- Selectie cards -->
        <div class="flex flex-col gap-4 max-w-2xl">

          <!-- Primair onderwijs -->
          <div id="card-po" class="selcard">
            <div class="selcard-header" onclick="toggleCard('po')" style="cursor:pointer">
              Primair onderwijs
              <span id="arrow-po" class="text-sm">▼</span>
            </div>
            <div id="body-po" class="selcard-body hidden">
              <div class="grid grid-cols-2 gap-x-6 gap-y-3 text-sm">

                <label class="form-label self-center">Aantal leerlingen</label>
                <div class="flex items-center gap-2">
                  <input id="po-leerlingen" type="number" class="input-field w-24" value="400"
                         oninput="updatePO()"/>
                </div>

                <label class="form-label self-center">BVO</label>
                <div class="flex items-center gap-2">
                  <span id="po-bvo-calc" class="font-semibold text-violet-700 w-20">2 255 m²</span>
                  <input id="po-bvo-hand" type="number" placeholder="handmatig" class="input-field w-28 text-xs"
                         oninput="updatePO()"/>
                </div>

                <label class="form-label self-center">Onderbouwplein</label>
                <div class="flex items-center gap-2">
                  <span id="po-kleuter-calc" class="font-semibold text-violet-700 w-20">350 m²</span>
                  <input id="po-kleuter-hand" type="number" placeholder="handmatig" class="input-field w-28 text-xs"
                         oninput="updatePO()"/>
                </div>

                <label class="form-label self-center">Bovenbouwplein</label>
                <div class="flex items-center gap-2">
                  <span id="po-kinder-calc" class="font-semibold text-violet-700 w-20">550 m²</span>
                  <input id="po-kinder-hand" type="number" placeholder="handmatig" class="input-field w-28 text-xs"
                         oninput="updatePO()"/>
                </div>

                <label class="form-label self-center">Aantal Fietsen</label>
                <div class="flex items-center gap-2">
                  <input id="po-fietsen" type="number" class="input-field w-24" value="160"
                         oninput="updatePO()"/>
                </div>

                <label class="form-label self-center">Fietsenstalling</label>
                <div class="flex items-center gap-2">
                  <span id="po-fietsen-calc" class="font-semibold text-violet-700 w-20">160 m²</span>
                  <input id="po-fietsen-hand" type="number" placeholder="handmatig" class="input-field w-28 text-xs"
                         oninput="updatePO()"/>
                </div>
              </div>
            </div>
          </div>

          <!-- Voorschoolse opvang -->
          <div id="card-vs" class="selcard">
            <div class="selcard-header" onclick="toggleCard('vs')" style="cursor:pointer">
              Voorschoolse opvang
              <span id="arrow-vs" class="text-sm">▼</span>
            </div>
            <div id="body-vs" class="selcard-body hidden">
              <div class="grid grid-cols-2 gap-x-6 gap-y-3 text-sm">

                <label class="form-label self-center">Aantal groepen</label>
                <div class="flex items-center gap-2">
                  <input id="vs-groepen" type="number" class="input-field w-24" value="2"
                         oninput="updateVS()"/>
                </div>

                <label class="form-label self-center">BVO</label>
                <div class="flex items-center gap-2">
                  <span id="vs-bvo-calc" class="font-semibold text-violet-700 w-20">230 m²</span>
                  <input id="vs-bvo-hand" type="number" placeholder="handmatig" class="input-field w-28 text-xs"
                         oninput="saveAll()"/>
                </div>

                <label class="form-label self-center">Plein</label>
                <div class="flex items-center gap-2">
                  <span id="vs-plein-calc" class="font-semibold text-violet-700 w-20">100 m²</span>
                  <input id="vs-plein-hand" type="number" placeholder="handmatig" class="input-field w-28 text-xs"
                         oninput="saveAll()"/>
                </div>

                

                <label class="form-label self-center">Aantal Fietsen</label>
                <div class="flex items-center gap-2">
                  <input id="vs-fietsen" type="number" class="input-field w-24" value="15"
                         oninput="updateVS()"/>
                </div>

                <label class="form-label self-center">Fietsenstalling</label>
                <div class="flex items-center gap-2">
                  <span id="vs-fietsen-calc" class="font-semibold text-violet-700 w-20">15 m²</span>
                  <input id="vs-fietsen-hand" type="number" placeholder="handmatig" class="input-field w-28 text-xs"
                         oninput="saveAll()"/>
                </div>
              </div>
            </div>
          </div>

          <!-- Sport -->
          <div id="card-sp" class="selcard">
            <div class="selcard-header" onclick="toggleCard('sp')" style="cursor:pointer">
              Sport
              <span id="arrow-sp" class="text-sm">▼</span>
            </div>
            <div id="body-sp" class="selcard-body hidden">
              <div class="grid grid-cols-2 gap-x-6 gap-y-3 text-sm">

                <label class="form-label self-center">Type</label>
                <select id="sp-type" class="select-field w-44" onchange="updateSP()">
                  <option value="gymzaal">Gymzaal (600 m²)</option>
                  <option value="sportzaal">Sportzaal (1 200 m²)</option>
                  <option value="sporthal">Sporthal (2 400 m²)</option>
                </select>

                <label class="form-label self-center">BVO</label>
                <div class="flex items-center gap-2">
                  <span id="sp-bvo-calc" class="font-semibold text-violet-700 w-20">600 m²</span>
                  <input id="sp-bvo-hand" type="number" placeholder="handmatig" class="input-field w-28 text-xs"
                         oninput="saveAll()"/>
                </div>
              </div>
            </div>
          </div>

          <!-- Totaal BVO + Plein -->
          <div class="flex justify-end items-center gap-6 pt-2 text-sm text-gray-600">
            <div class="flex items-center gap-2">
              <span>Totaal benodigd plein:</span>
              <span id="totaal-plein" class="font-bold text-violet-600 text-base">0 m²</span>
            </div>
            <div class="flex items-center gap-2">
              <span>Totaal benodigd BVO:</span>
              <span id="totaal-bvo" class="font-bold text-violet-600 text-base">0 m²</span>
            </div>
          </div>
        </div>

        <!-- Volgende stap -->
        <div class="flex justify-between items-end mt-8 max-w-2xl">
          <div id="dashboard-widget" class="dashboard-widget"></div>
          <button onclick="volgendeStap()" class="btn-primary px-6 py-2">volgende stap</button>
        </div>
      </div>
    </div>
  </div>

  <script src="js/state.js"></script>
  <script src="js/calculations.js"></script>
  <script>
    const project = getCurrentProject();
    if (!project) { window.location.href = 'index.html'; }
    const pveV = getActivePveVariant();
    if (!pveV) { window.location.href = 'pve-stap-1-invoer.html'; }

    document.getElementById('project-titel').textContent = project.naam;
    document.getElementById('step-indicator').innerHTML = renderStepIndicator(2, 5, ['pve-stap-1b-gebruiksduur.html']);
    document.getElementById('nav-panel').innerHTML = renderNavPanel('pve', project);

    const V = pveV.voorzieningen;

    // ── Card toggle ───────────────────────────────────────────────────────────
    function toggleCard(key) {
      const card = document.getElementById('card-' + key);
      const body = document.getElementById('body-' + key);
      const arrow = document.getElementById('arrow-' + key);
      const isSelected = card.classList.contains('selected');

      if (isSelected) {
        card.classList.remove('selected');
        body.classList.add('hidden');
        arrow.textContent = '▼';
        V[keyToField(key)].actief = false;
      } else {
        card.classList.add('selected');
        body.classList.remove('hidden');
        arrow.textContent = '▲';
        V[keyToField(key)].actief = true;
      }
      saveAll();
    }

    function keyToField(k) {
      return { po: 'primairOnderwijs', vs: 'voorschoolseOpvang', sp: 'sport' }[k];
    }

    // ── PO updates ─────────────────────────────────────────────────────────────
    function updatePO() {
      const ll = parseInt(document.getElementById('po-leerlingen').value) || 0;
      document.getElementById('po-bvo-calc').textContent    = POM_CALC.formatM2(POM_CALC.calcPrimairBVO(ll));
      document.getElementById('po-kleuter-calc').textContent = POM_CALC.formatM2(POM_CALC.calcOnderbouwplein(ll));
      document.getElementById('po-kinder-calc').textContent  = POM_CALC.formatM2(POM_CALC.calcBovenbouwplein(ll));
      const poFietsen = parseInt(document.getElementById('po-fietsen').value) || 0;
      document.getElementById('po-fietsen-calc').textContent = POM_CALC.formatM2(poFietsen);
      saveAll();
    }

    function updateVS() {
      const gr = parseInt(document.getElementById('vs-groepen').value) || 0;
      document.getElementById('vs-bvo-calc').textContent    = POM_CALC.formatM2(POM_CALC.calcVoorschoolseBVO(gr));
      document.getElementById('vs-plein-calc').textContent  = POM_CALC.formatM2(POM_CALC.calcVoorschoolsePlein(gr));
      const vsFietsen = parseInt(document.getElementById('vs-fietsen').value) || 0;
      document.getElementById('vs-fietsen-calc').textContent = POM_CALC.formatM2(vsFietsen);
      saveAll();
    }

    function updateSP() {
      const type = document.getElementById('sp-type').value;
      document.getElementById('sp-bvo-calc').textContent = POM_CALC.formatM2(POM_CALC.calcSportBVO(type));
      saveAll();
    }

    // ── Save all ──────────────────────────────────────────────────────────────
    function saveAll() {
      const po = V.primairOnderwijs;
      po.leerlingen          = parseInt(document.getElementById('po-leerlingen').value) || 400;
      po.fietsen             = parseInt(document.getElementById('po-fietsen').value) || 160;
      po.bvoHandmatig        = parseManual('po-bvo-hand');
      po.kleuterpleinHandmatig = parseManual('po-kleuter-hand');
      po.kinderpleinHandmatig  = parseManual('po-kinder-hand');
      po.fietsenstallingHandmatig = parseManual('po-fietsen-hand');

      const vs = V.voorschoolseOpvang;
      vs.groepen             = parseInt(document.getElementById('vs-groepen').value) || 2;
      vs.fietsen             = parseInt(document.getElementById('vs-fietsen').value) || 15;
      vs.bvoHandmatig        = parseManual('vs-bvo-hand');
      vs.pleinHandmatig      = parseManual('vs-plein-hand');
      vs.fietsenstallingHandmatig = parseManual('vs-fietsen-hand');

      const sp = V.sport;
      sp.type                = document.getElementById('sp-type').value;
      sp.bvoHandmatig        = parseManual('sp-bvo-hand');

      updateActivePveVariant({ voorzieningen: V });
      updateTotaal();
    }

    function parseManual(id) {
      const v = document.getElementById(id).value;
      return v ? parseInt(v) : null;
    }

    function updateTotaal() {
      const total = POM_CALC.calcTotalBVO(V);
      document.getElementById('totaal-bvo').textContent = POM_CALC.formatM2(total);

      let totalPlein = 0;
      const po = V.primairOnderwijs;
      if (po.actief) {
        const ll = po.leerlingen;
        totalPlein += po.kleuterpleinHandmatig  ?? POM_CALC.calcOnderbouwplein(ll);
        totalPlein += po.kinderpleinHandmatig   ?? POM_CALC.calcBovenbouwplein(ll);
        totalPlein += po.fietsenstallingHandmatig ?? (po.fietsen || 160);
      }
      const vs = V.voorschoolseOpvang;
      if (vs.actief) {
        totalPlein += vs.pleinHandmatig ?? POM_CALC.calcVoorschoolsePlein(vs.groepen);
        totalPlein += vs.fietsenstallingHandmatig ?? (vs.fietsen || 15);
      }
      document.getElementById('totaal-plein').textContent = POM_CALC.formatM2(totalPlein);

      document.getElementById('dashboard-widget').innerHTML = renderDashboard(getCurrentProject());
    }

    // ── Init from saved state ─────────────────────────────────────────────────
    function initFromState() {
      const po = V.primairOnderwijs;
      const vs = V.voorschoolseOpvang;
      const sp = V.sport;

      document.getElementById('po-leerlingen').value = po.leerlingen;
      if (po.fietsen)              document.getElementById('po-fietsen').value = po.fietsen;
      if (po.bvoHandmatig)        document.getElementById('po-bvo-hand').value    = po.bvoHandmatig;
      if (po.kleuterpleinHandmatig) document.getElementById('po-kleuter-hand').value = po.kleuterpleinHandmatig;
      if (po.kinderpleinHandmatig)  document.getElementById('po-kinder-hand').value  = po.kinderpleinHandmatig;
      if (po.fietsenstallingHandmatig) document.getElementById('po-fietsen-hand').value = po.fietsenstallingHandmatig;

      document.getElementById('vs-groepen').value = vs.groepen;
      if (vs.fietsen)              document.getElementById('vs-fietsen').value = vs.fietsen;
      if (vs.bvoHandmatig)   document.getElementById('vs-bvo-hand').value   = vs.bvoHandmatig;
      if (vs.pleinHandmatig) document.getElementById('vs-plein-hand').value = vs.pleinHandmatig;
      if (vs.fietsenstallingHandmatig) document.getElementById('vs-fietsen-hand').value = vs.fietsenstallingHandmatig;

      document.getElementById('sp-type').value = sp.type || 'gymzaal';

      [['po', po], ['vs', vs], ['sp', sp]].forEach(([k, d]) => {
        if (d.actief) {
          document.getElementById('card-' + k).classList.add('selected');
          document.getElementById('body-' + k).classList.remove('hidden');
          document.getElementById('arrow-' + k).textContent = '▲';
        }
      });

      updatePO(); updateVS(); updateSP();
    }

    function volgendeStap() {
      saveAll();
      window.location.href = 'pve-stap-4-ruimte.html';
    }

    initFromState();
  </script>
  <script src="js/dashboard-detail.js"></script>
  <script src="js/bot.js"></script>
</body>
</html>
